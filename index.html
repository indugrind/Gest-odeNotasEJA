<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NotaSys Pro - Gest√£o Acad√™mica de M√∫ltiplas Turmas</title>
    <!-- Favicon SVG para melhor qualidade e customiza√ß√£o -->
    <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%23F2C94C'%3E%3Cpath d='M12 3L1 9l11 6 9-4.91V17h2V9L12 3zm0 8.69L3.41 7.09 12 5.31l8.59 1.78L12 11.69z M5 13.18V17.5h14v-4.32l-7 3.11-7-3.11z'/%3E%3C/svg%3E">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <!-- Biblioteca de gr√°ficos Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* Paleta de Cores e Vari√°veis Globais */
        :root {
            --primary: #F2C94C; --primary-dark: #E0B849;
            --success: #28A745; --success-dark: #218838;
            --danger: #D73A49; --danger-dark: #B02A37;
            --warning: #F2994A; --warning-dark: #E68A42;
            --light-bg: #F7F9FC; --light-card: #FFFFFF; --light-border: #E1E4E8;
            --light-text: #242A31; --light-text-secondary: #6A737D; --light-shadow: rgba(36, 42, 49, 0.1);
            --dark-bg: #1C2128; --dark-card: #22272E; --dark-border: #373E47;
            --dark-text: #E6EDF3; --dark-text-secondary: #909DAB; --dark-shadow: rgba(0, 0, 0, 0.3);
            --bg-color: var(--light-bg); --card-color: var(--light-card); --border-color: var(--light-border);
            --text-color: var(--light-text); --text-secondary-color: var(--light-text-secondary); --shadow-color: var(--light-shadow);
        }
        /* Estilos para o Modo Escuro */
        .dark-mode {
            --bg-color: var(--dark-bg); --card-color: var(--dark-card); --border-color: var(--dark-border);
            --text-color: var(--dark-text); --text-secondary-color: var(--dark-text-secondary); --shadow-color: var(--dark-shadow);
        }
        /* Reset e Estilos Base */
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', 'Segoe UI', sans-serif; }
        html { scroll-behavior: smooth; font-size: 16px; }
        body { background-color: var(--bg-color); color: var(--text-color); line-height: 1.6; padding: 20px; transition: background-color 0.3s, color 0.3s; -webkit-text-size-adjust: 100%; }
        .container { max-width: 1400px; margin: 0 auto; }
        /* Componentes da UI */
        .header-controls { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        header { background: linear-gradient(135deg, var(--primary), var(--primary-dark)); color: var(--light-text); padding: 20px; border-radius: 12px; margin-bottom: 30px; box-shadow: 0 6px 12px var(--shadow-color); text-align: center; }
        header h1 { font-size: 2.5rem; margin-bottom: 10px; }
        header p { font-size: 1.1rem; opacity: 0.9; }
        .card { background: var(--card-color); border-radius: 12px; padding: 25px; margin-bottom: 25px; box-shadow: 0 4px 8px var(--shadow-color); transition: background-color 0.3s, opacity 0.3s, transform 0.3s; }
        .card h2 { color: var(--primary); margin-bottom: 20px; padding-bottom: 10px; border-bottom: 1px solid var(--border-color); }
        .form-group { margin-bottom: 20px; }
        label { display: block; margin-bottom: 8px; font-weight: 600; color: var(--text-color); }
        input, select, textarea { width: 100%; padding: 12px 15px; border: 1px solid var(--border-color); background-color: var(--bg-color); color: var(--text-color); border-radius: 8px; font-size: 1rem; transition: all 0.3s; }
        textarea { min-height: 150px; font-family: monospace; }
        input:focus, select:focus, textarea:focus { border-color: var(--primary); outline: none; box-shadow: 0 0 0 3px rgba(242, 201, 76, 0.25); }
        input.is-invalid { border-color: var(--danger); } .validation-message { color: var(--danger); font-size: 0.9rem; margin-top: 5px; }
        button { background-color: var(--primary); color: #fff; border: none; padding: 12px 20px; border-radius: 8px; cursor: pointer; font-size: 1rem; font-weight: 600; transition: all 0.2s; margin: 5px; }
        button.btn-primary { color: var(--light-text); }
        button:hover { transform: translateY(-2px); box-shadow: 0 4px 8px var(--shadow-color); }
        button:disabled { background-color: #95a5a6; cursor: not-allowed; transform: none; box-shadow: none; }
        .btn-success { background-color: var(--success); } .btn-success:hover { background-color: var(--success-dark); }
        .btn-danger { background-color: var(--danger); } .btn-danger:hover { background-color: var(--danger-dark); }
        .btn-warning { background-color: var(--warning); } .btn-warning:hover { background-color: var(--warning-dark); }
        .btn-secondary { background-color: var(--text-secondary-color); } .btn-secondary:hover { background-color: var(--text-color); }
        .btn-small { padding: 8px 12px; font-size: 0.9rem; }
        .grid { display: grid; gap: 20px; } .grid-2 { grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); }
        .table-responsive { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { padding: 14px 16px; text-align: left; border-bottom: 1px solid var(--border-color); white-space: nowrap; }
        th { background-color: var(--bg-color); color: var(--text-color); font-weight: 600; cursor: pointer; user-select: none; }
        th:hover { color: var(--primary); }
        .sort-asc::after { content: ' ‚ñ≤'; } .sort-desc::after { content: ' ‚ñº'; }
        tr:hover { background-color: rgba(242, 201, 76, 0.07); }
        .status-Aprovado { color: var(--success); font-weight: 600; } .status-Reprovado { color: var(--danger); font-weight: 600; }
        .stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; }
        .stat-card { background: var(--card-color); border-radius: 12px; padding: 20px; text-align: center; }
        .stat-value { font-size: 2.5rem; font-weight: 700; margin: 10px 0; }
        .stat-aprovados { color: var(--success); } .stat-reprovados { color: var(--danger); }
        .actions { display: flex; flex-wrap: wrap; gap: 10px; }
        .hidden { display: none !important; }
        .disciplina-section { margin-bottom: 10px; border: 1px solid var(--border-color); border-radius: 12px; }
        .disciplina-section summary { background: var(--bg-color); padding: 15px; border-radius: 8px; cursor: pointer; list-style: none; font-weight: 600; }
        .disciplina-section summary::-webkit-details-marker { display: none; }
        .disciplina-section[open] summary { border-bottom-left-radius: 0; border-bottom-right-radius: 0; background: var(--primary); color: var(--light-text); }
        .disciplina-content { padding: 20px; }
        .bimestre-tabs { display: flex; margin-bottom: 20px; border-bottom: 2px solid var(--border-color); flex-wrap: wrap; }
        .bimestre-tab { padding: 10px 20px; cursor: pointer; border-bottom: 3px solid transparent; }
        .bimestre-tab.active { border-bottom: 3px solid var(--primary); color: var(--primary); font-weight: 600; }
        .total-display { background-color: var(--bg-color); font-weight: 600; color: var(--text-color); }
        .config-box { border: 1px solid var(--border-color); border-radius: 8px; padding: 15px; margin-bottom: 20px; }
        #approvalRuleSummary { background-color: #FFF9E6; border-left: 5px solid var(--primary); padding: 15px; margin-top: 10px; font-weight: 600; color: #B89007; border-radius: 5px; }
        .dark-mode #approvalRuleSummary { background-color: rgba(242, 201, 76, 0.1); color: var(--dark-text-secondary); border-left-color: var(--primary);}
        .alert { padding: 15px; border-radius: 8px; margin: 10px 0; font-weight: 600; border: 1px solid transparent; }
        .alert-success { background: #d4edda; color: #155724; border-color: #c3e6cb; }
        .alert-error { background: #f8d7da; color: #721c24; border-color: #f5c6cb; }
        .alert-warning { background: #fff3cd; color: #856404; border-color: #ffeeba; }
        .dark-mode .alert-success { background-color: #1e4620; color: #a3d9a5; border-color: #2e6b30; }
        .dark-mode .alert-error { background-color: #58151c; color: #f1b0b7; border-color: #842029; }
        .dark-mode .alert-warning { background-color: #664d03; color: #ffda6a; border-color: #997404; }
        .add-disciplina-section { background: var(--bg-color); border: 2px dashed var(--success); border-radius: 12px; padding: 20px; text-align: center; margin-bottom: 20px; }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.6); display: flex; justify-content: center; align-items: center; z-index: 1000; opacity: 0; visibility: hidden; transition: opacity 0.3s, visibility 0.3s; }
        .modal-overlay.visible { opacity: 1; visibility: visible; }
        .modal { background: var(--card-color); padding: 30px; border-radius: 12px; width: 90%; max-width: 500px; text-align: center; transform: scale(0.9); transition: transform 0.3s; }
        .modal-overlay.visible .modal { transform: scale(1); }
        #detailsModal .modal, #boletimModal .modal, #importModal .modal, #disciplinasModal .modal { max-width: 800px; text-align: left; }
        .modal h3 { margin-bottom: 15px; color: var(--primary); }
        .modal p { margin-bottom: 25px; color: var(--text-secondary-color); }
        .modal-buttons { display: flex; justify-content: center; gap: 15px; }
        .theme-switch-wrapper { display: flex; align-items: center; gap: 10px; }
        .theme-switch { display: inline-block; height: 24px; position: relative; width: 48px; }
        .theme-switch input { display:none; }
        .slider { background-color: #ccc; bottom: 0; cursor: pointer; left: 0; position: absolute; right: 0; top: 0; transition: .4s; border-radius: 24px; }
        .slider:before { background-color: #fff; bottom: 2px; content: ""; height: 20px; left: 2px; position: absolute; transition: .4s; width: 20px; border-radius: 50%; }
        input:checked + .slider { background-color: var(--primary); }
        input:checked + .slider:before { transform: translateX(24px); }
        .chart-container { position: relative; height: 300px; width: 100%; margin-top: 20px; }
        #boletimContent, #importPreview { text-align: left; }
        #boletimContent table, #importPreview table { width: 100%; margin-top: 15px; }
        #boletimContent th, #boletimContent td, #importPreview th, #importPreview td { padding: 8px; border: 1px solid var(--border-color); }
        #importInstructions { padding: 15px; background: var(--bg-color); border-radius: 8px; margin-bottom: 15px; font-size: 0.9em; word-break: break-all; }
        #importPreview tr.error-row { background-color: rgba(215, 58, 73, 0.1); }
        #disciplinasList { display: flex; flex-wrap: wrap; gap: 10px; padding: 10px; background: var(--bg-color); border-radius: 8px; }
        .disciplina-tag { background: var(--primary); color: var(--light-text); padding: 5px 10px; border-radius: 15px; display: flex; align-items: center; gap: 8px; font-size: 0.9rem; }
        .disciplina-tag button { background: none; border: none; color: inherit; cursor: pointer; padding: 0; margin: 0; font-size: 1.1rem; line-height: 1; }
        #student-form.hidden { max-height: 0; overflow: hidden; padding-top: 0; padding-bottom: 0; margin-top: 0; margin-bottom: 0; opacity: 0; transform: translateY(-20px); transition: all 0.5s ease-in-out; }
        #student-form { max-height: 5000px; overflow: hidden; opacity: 1; transform: translateY(0); transition: all 0.5s ease-in-out; }
        .btn-loading-spinner { display: inline-block; width: 1.2em; height: 1.2em; border: 3px solid rgba(255, 255, 255, 0.3); border-radius: 50%; border-top-color: #fff; animation: spin 1s ease-in-out infinite; -webkit-animation: spin 1s ease-in-out infinite; margin-right: 8px; vertical-align: middle; }
        @keyframes spin { to { transform: rotate(360deg); } }
        @-webkit-keyframes spin { to { -webkit-transform: rotate(360deg); } }
        button .btn-text { vertical-align: middle; }

        /* Media Queries para Responsividade */
        @media (max-width: 768px) {
            html { font-size: 14px; } body { padding: 10px; } header h1 { font-size: 1.8rem; }
            .card { padding: 15px; } .grid-2, .grid-3, .grid-5 { grid-template-columns: 1fr; }
            .header-controls { flex-direction: column; gap: 15px; align-items: center; }
            button, input, select, textarea { font-size: 1rem; padding: 10px 12px; }

            .table-responsive { overflow-x: visible; }
            #studentsTable thead { display: none; }
            #studentsTable, #studentsTable tbody, #studentsTable tr, #studentsTable td { display: block; width: 100%; }
            #studentsTable tr {
                background: var(--card-color);
                border: 1px solid var(--border-color);
                border-radius: 12px;
                margin-bottom: 15px;
                padding: 15px;
                box-shadow: 0 2px 4px var(--shadow-color);
            }
            #studentsTable td {
                display: flex;
                justify-content: space-between;
                align-items: center;
                text-align: right;
                padding: 10px 0;
                border-bottom: 1px solid var(--border-color);
                white-space: normal;
            }
            #studentsTable td:last-child { border-bottom: none; padding-top: 15px; }
            #studentsTable td[data-label]::before {
                content: attr(data-label);
                font-weight: 600;
                text-align: left;
                margin-right: 10px;
                color: var(--text-secondary-color);
            }
            #studentsTable td.actions-cell { justify-content: flex-end; }
        }
        /* Estilos de Impress√£o */
        @media print { 
            body * { visibility: hidden; } #boletimModal, #boletimModal * { visibility: visible; } 
            #boletimModal { position: absolute; left: 0; top: 0; width: 100%; height: 100%; } 
            #boletimModal .modal-buttons { display: none; } #boletimModal .modal { box-shadow: none; border: 1px solid #000; } 
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>NotaSys Pro</h1>
            <p>Sistema de Gest√£o Acad√™mica com M√∫ltiplas Turmas</p>
        </header>

        <div class="header-controls">
            <div class="theme-switch-wrapper">
                <span>‚òÄÔ∏è</span>
                <label class="theme-switch" for="darkModeToggle">
                    <input type="checkbox" id="darkModeToggle" />
                    <span class="slider round"></span>
                </label>
                <span>üåô</span>
            </div>
        </div>

        <div id="alertContainer" role="status" aria-live="polite"></div>

        <div class="card">
            <h2>üè´ Gest√£o de Turmas</h2>
            <div class="grid grid-2">
                <div class="form-group">
                    <label for="turmaSelect">Turma Ativa</label>
                    <select id="turmaSelect"></select>
                </div>
                <div class="actions" style="align-self: end;">
                    <button id="createTurmaBtn" class="btn-success">‚ûï Criar Turma</button>
                    <button id="renameTurmaBtn" class="btn-primary">‚úèÔ∏è Renomear</button>
                    <button id="deleteTurmaBtn" class="btn-danger">üóëÔ∏è Excluir Turma</button>
                </div>
            </div>
        </div>
        
        <div id="turma-content">
            <div class="card">
                <h2>‚öôÔ∏è Configura√ß√£o da Turma</h2>
                <div class="grid grid-2">
                    <div class="config-box">
                        <h3>üóìÔ∏è Estrutura do Ano Letivo</h3>
                        <div class="form-group"><label for="numBimestres">N√∫mero de Bimestres</label><input type="number" id="numBimestres" min="1" max="4" value="4"></div>
                        <h3>üíØ Pontua√ß√£o por Disciplina</h3>
                        <div class="form-group">
                            <label for="maxPontosDisciplina">Pontua√ß√£o M√°xima por Disciplina (em cada bimestre)</label>
                            <input type="number" id="maxPontosDisciplina" min="1" step="1" value="50">
                        </div>
                    </div>
                    <div class="config-box">
                        <h3>üìä Crit√©rios de Aprova√ß√£o</h3>
                        <div class="form-group"><label for="minPontosBimestre">Pontua√ß√£o M√≠nima POR BIMESTRE (soma)</label><input type="number" id="minPontosBimestre" min="0" step="1" value="30"></div>
                        <div class="form-group"><label for="minPontosAnual">Pontua√ß√£o M√≠nima ANUAL (soma final)</label><input type="number" id="minPontosAnual" min="0" step="1" value="60"></div>
                        <div id="approvalRuleSummary"></div>
                    </div>
                </div>
                <button id="aplicarConfig" class="btn-success">üíæ <span class="btn-text">Aplicar Configura√ß√µes</span></button>
            </div>

            <div class="card">
                <h2>üìö Disciplinas da Turma</h2>
                <label>Disciplinas Atuais:</label>
                <div id="disciplinasList"></div>
                <div class="add-disciplina-section">
                    <div class="grid grid-2">
                        <div class="form-group"><label for="novaDisciplina">Adicionar Nova Disciplina</label><input type="text" id="novaDisciplina" placeholder="Ex: Hist√≥ria"></div>
                        <div class="form-group" style="align-self: end;"><button type="button" id="adicionarDisciplina" class="btn-success">‚ûï Adicionar</button></div>
                    </div>
                </div>
                <div class="actions"><button id="bulkAddDisciplinas" class="btn-primary">Adicionar em Massa</button></div>
            </div>
            
            <div id="student-management-card" class="card">
                <h2 id="student-form-title">Gest√£o de Alunos</h2>
                <p id="form-placeholder" class="alert">Selecione um aluno na lista abaixo para ver ou editar as suas notas, ou clique em 'Adicionar Novo Aluno'.</p>
                <form id="student-form" class="hidden">
                    <div class="grid grid-2">
                        <div class="form-group">
                            <label for="studentName">Nome *</label><input type="text" id="studentName" required>
                        </div>
                        <div class="form-group">
                            <label for="studentId">Matr√≠cula *</label><input type="text" id="studentId" required>
                            <div id="studentId-validation" class="validation-message"></div>
                        </div>
                    </div>
                    <div class="bimestre-tabs" id="bimestreTabsContainer"></div>
                    <div id="bimestresContentContainer"></div>
                    <div class="grid grid-2" style="margin-top: 20px;">
                        <div class="form-group"><label for="totalGeral">Total Anual (Soma de Pontos)</label><input type="text" id="totalGeral" class="total-display" readonly></div>
                        <div class="form-group"><label for="statusFinal">Status Final</label><input type="text" id="statusFinal" class="total-display" readonly></div>
                    </div>
                    <div class="form-group">
                        <button type="submit" id="submit-btn" class="btn-success">üíæ <span class="btn-text">Salvar</span></button>
                        <button type="button" id="clear-form-btn" class="btn-danger">üóëÔ∏è Cancelar</button>
                    </div>
                </form>
            </div>
            
            <div class="card">
                <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px;">
                    <h2>üìã Lista de Alunos</h2>
                    <button id="show-add-form-btn" class="btn-success">‚ûï Adicionar Novo Aluno</button>
                </div>
                <div class="form-group"><label for="searchStudent">üîé Buscar por Nome ou Matr√≠cula</label><input type="text" id="searchStudent" placeholder="Digite para buscar..."></div>
                <div class="table-responsive">
                    <table id="studentsTable">
                        <thead>
                            <tr>
                                <!-- O CABE√áALHO SER√Å GERADO DINAMICAMENTE PELO JAVASCRIPT -->
                            </tr>
                        </thead>
                        <tbody id="studentsList"></tbody>
                    </table>
                </div>
                <div id="emptyMessage" class="alert hidden">Nenhum aluno cadastrado.</div>
            </div>

            <div class="card">
                <h2>üìà Relat√≥rios Avan√ßados</h2>
                <div class="grid grid-2">
                    <div class="form-group"><label for="reportSubject">Analisar Desempenho em:</label><select id="reportSubject"></select></div>
                    <div class="form-group">
                        <label>Faixas de Desempenho (%)</label>
                        <div class="grid" style="grid-template-columns: repeat(5, 1fr); gap: 10px;">
                            <input type="number" class="report-range-input" id="range1" value="20" min="0" max="100">
                            <input type="number" class="report-range-input" id="range2" value="40" min="0" max="100">
                            <input type="number" class="report-range-input" id="range3" value="60" min="0" max="100">
                            <input type="number" class="report-range-input" id="range4" value="80" min="0" max="100">
                            <input type="number" class="report-range-input" id="range5" value="100" min="0" max="100" readonly>
                        </div>
                    </div>
                </div>
                <div class="chart-container"><canvas id="advancedReportChart"></canvas></div>
            </div>
            <div class="card">
                <h2>üìä Estat√≠sticas da Turma</h2>
                <div class="stats grid-3">
                    <div class="stat-card">
                        <h3>Alunos</h3>
                        <div class="stat-value" id="totalStudents">0</div>
                    </div>
                    <div class="stat-card">
                        <h3>Aprovados</h3>
                        <div class="stat-value stat-aprovados" id="approvedStudents">0</div>
                    </div>
                    <div class="stat-card">
                        <h3>Reprovados</h3>
                        <div class="stat-value stat-reprovados" id="failedStudents">0</div>
                    </div>
                </div>
            </div>
            <div class="card">
                <h2>üíæ Dados da Turma</h2>
                <p class="text-secondary-color" style="margin-top: -15px; margin-bottom: 15px;">Use as fun√ß√µes abaixo para salvar ou carregar os dados da turma <strong>ativa</strong>.</p>
                <div class="actions">
                    <button id="exportCSV" class="btn-success">üìÑ Exportar CSV</button>
                    <button id="backupData" class="btn-success">üíæ Fazer Backup</button>
                    <button id="importData" class="btn-warning">üì• Importar Backup</button>
                    <button id="importBulkData" class="btn-primary">üìä Importar Alunos em Massa</button>
                    <button id="resetSystem" class="btn-danger">üóëÔ∏è Resetar Dados da Turma</button>
                </div>
                <input type="file" id="importFile" class="hidden" accept=".json">
            </div>
        </div>
    </div>

    <!-- Modais da Aplica√ß√£o -->
    <div id="modal" class="modal-overlay" role="dialog" aria-modal="true" aria-labelledby="modalTitle"><div class="modal"><h3 id="modalTitle"></h3><p id="modalMessage"></p><div class="modal-buttons"><button id="modalConfirm" class="btn-danger">Confirmar</button><button id="modalCancel" class="btn-secondary">Cancelar</button></div></div></div>
    <div id="detailsModal" class="modal-overlay" role="dialog" aria-modal="true" aria-labelledby="detailsModalTitle"><div class="modal"><h3 id="detailsModalTitle"></h3><p id="detailsModalSubtitle"></p><div class="chart-container"><canvas id="studentChart"></canvas></div><div class="modal-buttons"><button id="detailsModalClose" class="btn-secondary">Fechar</button></div></div></div>
    <div id="boletimModal" class="modal-overlay" role="dialog" aria-modal="true"><div class="modal"><div id="boletimContent"></div><div class="modal-buttons"><button id="printBoletim" class="btn-success">üñ®Ô∏è Imprimir</button><button id="boletimModalClose" class="btn-secondary">Fechar</button></div></div></div>
    <div id="importModal" class="modal-overlay" role="dialog" aria-modal="true" aria-labelledby="importModalTitle"><div class="modal"><h3 id="importModalTitle">Importa√ß√£o de Alunos em Massa</h3><p>Cole os dados da sua planilha. Separe colunas com ponto e v√≠rgula (;). A nota a ser colada √© a nota da disciplina no bimestre.</p><div id="importInstructions"></div><textarea id="bulkDataInput" placeholder="Ex: 123;Jo√£o da Silva;45;2;..."></textarea><div id="importPreview"></div><div class="modal-buttons"><button id="importModalConfirm" class="btn-success" disabled>Confirmar Importa√ß√£o</button><button id="importModalCancel" class="btn-secondary">Cancelar</button></div></div></div>
    <div id="disciplinasModal" class="modal-overlay" role="dialog" aria-modal="true" aria-labelledby="disciplinasModalTitle"><div class="modal"><h3 id="disciplinasModalTitle">Adicionar Disciplinas em Massa</h3><p>Cole a lista de disciplinas abaixo, uma por linha.</p><textarea id="bulkDisciplinasInput"></textarea><div class="modal-buttons"><button id="disciplinasModalConfirm" class="btn-success">Salvar Lista</button><button id="disciplinasModalCancel" class="btn-secondary">Cancelar</button></div></div></div>

    <script>
    /**
     * NotaSys Pro - Academic Management System with Multi-Class Support
     *
     * @version 3.5.0
     * @author Gemini (Refactored & Upgraded)
     * - L√≥gica de pontua√ß√£o e aprova√ß√£o ajustada para o modelo da EJA.
     * - Agora a pontua√ß√£o √© definida por disciplina, e a aprova√ß√£o se baseia
     * na soma m√≠nima por bimestre e na soma total anual.
     */
    document.addEventListener('DOMContentLoaded', () => {
        const App = {
            // --- GERENCIAMENTO DE ESTADO ---
            state: {
                turmas: {},
                activeTurmaId: null,
                studentToEdit: null,
                sort: { column: 'name', order: 'asc' },
                charts: { studentChart: null, advancedReportChart: null },
                parsedStudents: [],
            },

            // --- FUN√á√ÉO AUXILIAR PRINCIPAL ---
            getActiveTurma() {
                if (this.state.activeTurmaId && this.state.turmas[this.state.activeTurmaId]) {
                    return this.state.turmas[this.state.activeTurmaId];
                }
                return null;
            },

            // --- UTILIT√ÅRIOS ---
            utils: {
                doc: (s) => document.querySelector(s),
                docAll: (s) => document.querySelectorAll(s),
                toId: (n) => n.toString().toLowerCase().replace(/[^a-z0-9]/g, '_'),
                showAlert(msg, type = 'success', duration = 5000) {
                    const container = this.doc('#alertContainer');
                    const alert = document.createElement('div');
                    alert.className = `alert alert-${type}`;
                    alert.textContent = msg;
                    container.innerHTML = '';
                    container.appendChild(alert);
                    setTimeout(() => alert.remove(), duration);
                },
                showModal(id, onConfirm) {
                    const modal = this.doc(id);
                    if (!modal) return;
                    modal.classList.add('visible');
                    const confirmBtn = this.doc(`${id}Confirm`);
                    const cancelBtn = this.doc(`${id}Cancel`) || this.doc(`${id}Close`);
                    const hide = () => {
                        modal.classList.remove('visible');
                        if (confirmBtn) confirmBtn.onclick = null;
                        if (cancelBtn) cancelBtn.onclick = null;
                        modal.onclick = null;
                    };
                    if (confirmBtn) {
                        confirmBtn.onclick = () => { if (typeof onConfirm === 'function') onConfirm(); hide(); };
                    }
                    if (cancelBtn) cancelBtn.onclick = hide;
                    modal.onclick = (e) => { if (e.target === modal) hide(); };
                },
                debounce(func, delay) {
                    let timeout;
                    return (...args) => {
                        clearTimeout(timeout);
                        timeout = setTimeout(() => func.apply(this, args), delay);
                    };
                },
                setButtonLoadingState(button, isLoading, loadingText = 'Salvando...') {
                    if (isLoading) {
                        button.disabled = true;
                        button.dataset.originalContent = button.innerHTML;
                        button.innerHTML = `<span class="btn-loading-spinner"></span><span class="btn-text">${loadingText}</span>`;
                    } else {
                        button.disabled = false;
                        if (button.dataset.originalContent) {
                            button.innerHTML = button.dataset.originalContent;
                        }
                    }
                },
                async showButtonSuccessState(button, successText = 'Salvo!', duration = 1500) {
                    if (button.dataset.originalContent) {
                        button.innerHTML = `‚úì <span class="btn-text">${successText}</span>`;
                        await new Promise(resolve => setTimeout(resolve, duration));
                        button.innerHTML = button.dataset.originalContent;
                        button.disabled = false;
                    }
                }
            },

            // --- ARMAZENAMENTO LOCAL ---
            storage: {
                KEYS: {
                    TURMAS: 'notasys_pro_v3_turmas',
                    ACTIVE_TURMA_ID: 'notasys_pro_v3_active_turma_id',
                    THEME: 'notasys_pro_v2_theme',
                },
                load() {
                    try {
                        const turmasData = localStorage.getItem(this.KEYS.TURMAS);
                        if (turmasData) {
                            App.state.turmas = JSON.parse(turmasData);
                            
                            let migrated = false;
                            Object.values(App.state.turmas).forEach(turma => {
                                if (turma.config && (turma.config.maxPontosBimestre !== undefined || turma.config.version < "3.5.0")) {
                                    console.log(`Migrando turma: ${turma.name}`);
                                    turma.config.version = "3.5.0";
                                    turma.config.numBimestres = turma.config.numBimestres || 4;
                                    turma.config.maxPontosDisciplina = 50;
                                    turma.config.minPontosBimestre = 30;
                                    turma.config.minPontosAnual = 60;
                                    delete turma.config.maxPontosBimestre;
                                    delete turma.config.minNotaBimestre;
                                    delete turma.config.minMediaFinal;
                                    migrated = true;
                                }
                            });

                            if (migrated) {
                                App.utils.showAlert('Seus dados foram atualizados para o novo sistema de pontua√ß√£o da EJA. Verifique as configura√ß√µes.', 'warning', 10000);
                                this.save(); 
                            }

                            App.state.activeTurmaId = localStorage.getItem(this.KEYS.ACTIVE_TURMA_ID);
                            if (!App.state.activeTurmaId || !App.state.turmas[App.state.activeTurmaId]) {
                                App.state.activeTurmaId = Object.keys(App.state.turmas)[0] || null;
                            }
                        }

                        if (Object.keys(App.state.turmas).length === 0) {
                            const newId = crypto.randomUUID();
                            App.state.turmas[newId] = this.createDefaultTurma('Minha Primeira Turma');
                            App.state.activeTurmaId = newId;
                            this.save();
                        }
                        
                        const theme = localStorage.getItem(this.KEYS.THEME);
                        if (theme === 'dark') {
                            App.utils.doc('body').classList.add('dark-mode');
                            App.utils.doc('#darkModeToggle').checked = true;
                        }
                    } catch (e) {
                        console.error("Error loading data:", e);
                        App.utils.showAlert('Erro fatal ao carregar dados. Verifique o console.', 'error');
                    }
                },
                save() {
                    try {
                        const activeTurma = App.getActiveTurma();
                        if (activeTurma) {
                            activeTurma.students.forEach(student => {
                                const updatedMetrics = App.logic.calculateTotalsAndStatus(student);
                                Object.assign(student, updatedMetrics);
                            });
                        }
                        localStorage.setItem(this.KEYS.TURMAS, JSON.stringify(App.state.turmas));
                        if (App.state.activeTurmaId) {
                            localStorage.setItem(this.KEYS.ACTIVE_TURMA_ID, App.state.activeTurmaId);
                        }
                        return true;
                    } catch (e) {
                        console.error("Error saving data:", e);
                        App.utils.showAlert('Erro ao salvar dados.', 'error');
                        return false;
                    }
                },
                createDefaultTurma(name) {
                    return {
                        id: crypto.randomUUID(), name: name, students: [],
                        disciplinas: ['Portugu√™s', 'Matem√°tica'],
                        config: {
                            version: "3.5.0",
                            numBimestres: 4,
                            maxPontosDisciplina: 50,
                            minPontosBimestre: 30,
                            minPontosAnual: 60,
                            reportRanges: [20, 40, 60, 80, 100],
                        },
                    };
                }
            },

            // --- L√ìGICA DE NEG√ìCIO ---
            logic: {
                calculateTotalsAndStatus(studentData) {
                    try {
                        let totalGeral = 0;
                        const bimestreTotals = [];
                        const activeTurma = App.getActiveTurma();
                        if (!activeTurma) return { totalGeral: '0.0', status: { text: 'Erro', class: 'status-Reprovado' }, bimestreTotals: [] };
                        const { config, disciplinas } = activeTurma;

                        for (let i = 0; i < config.numBimestres; i++) {
                            let totalBimestre = 0;
                            disciplinas.forEach(d => {
                                const nota = studentData.bimestres[i]?.[App.utils.toId(d)];
                                if (nota) {
                                    totalBimestre += nota.total || 0;
                                }
                            });
                            bimestreTotals.push(totalBimestre);
                        }
                        
                        totalGeral = bimestreTotals.reduce((acc, current) => acc + current, 0);

                        const abaixoMinimoBimestre = bimestreTotals.some(total => total < config.minPontosBimestre);
                        const isAprovado = !abaixoMinimoBimestre && totalGeral >= config.minPontosAnual;

                        const status = { text: isAprovado ? 'Aprovado' : 'Reprovado', class: isAprovado ? 'status-Aprovado' : 'status-Reprovado' };
                        return { totalGeral: totalGeral.toFixed(1), status, bimestreTotals }; 
                    } catch (e) {
                        console.error("Error calculating totals:", e);
                        return { totalGeral: '0.0', status: { text: 'Erro', class: 'status-Reprovado' }, bimestreTotals: [] }; 
                    }
                },
                validateStudentData(data, isEditing) {
                    const activeTurma = App.getActiveTurma();
                    if (!activeTurma) return { valid: false, message: 'Nenhuma turma ativa.' };
                    const { name, studentId } = data;
                    if (!name || !studentId) return { valid: false, message: 'Nome e matr√≠cula s√£o obrigat√≥rios.' };
                    const duplicate = activeTurma.students.some(s => s.studentId === studentId && s.studentId !== App.state.studentToEdit?.studentId);
                    if (duplicate) return { valid: false, message: 'Esta matr√≠cula j√° est√° em uso por outro aluno nesta turma.' };
                    return { valid: true, message: '' };
                },
                validateConfig(config) {
                    if (config.numBimestres < 1 || config.numBimestres > 4) return "N√∫mero de bimestres deve ser entre 1 e 4.";
                    if (config.maxPontosDisciplina <= 0) return "A pontua√ß√£o m√°xima por disciplina deve ser maior que zero.";
                    if (config.minPontosBimestre < 0 || config.minPontosAnual < 0) return "As pontua√ß√µes m√≠nimas n√£o podem ser negativas.";
                    if (config.minPontosAnual < config.minPontosBimestre * config.numBimestres) {
                        return "A pontua√ß√£o m√≠nima anual deve ser igual ou maior que a soma das pontua√ß√µes m√≠nimas de todos os bimestres.";
                    }
                    return null;
                }
            },

            // --- RENDERIZA√á√ÉO E MANIPULA√á√ÉO DO DOM ---
            view: {
                init() {
                    this.renderAll();
                    this.initEventListeners();
                },
                renderAll() {
                    this.renderTurmaSelector();
                    const activeTurma = App.getActiveTurma();
                    App.utils.doc('#turma-content').style.display = activeTurma ? '' : 'none';
                    if (activeTurma) {
                        this.populateConfigForm(); this.renderDisciplinasConfig(); this.renderFormStructure();
                        this.renderStudents(); this.updateStatistics(); this.renderAdvancedReports();
                        this.updateConfigSummary();
                    } else {
                        App.utils.showAlert('Nenhuma turma selecionada. Crie uma nova turma para come√ßar.', 'warning', 10000);
                    }
                },
                initEventListeners() {
                    const debouncedRenderStudents = App.utils.debounce(() => this.renderStudents(), 300);
                    App.utils.doc('#turmaSelect').addEventListener('change', this.handleTurmaSelect.bind(this));
                    App.utils.doc('#createTurmaBtn').addEventListener('click', this.handleCreateTurma.bind(this));
                    App.utils.doc('#renameTurmaBtn').addEventListener('click', this.handleRenameTurma.bind(this));
                    App.utils.doc('#deleteTurmaBtn').addEventListener('click', this.handleDeleteTurma.bind(this));
                    App.utils.doc('#student-form').addEventListener('submit', this.handleFormSubmit.bind(this));
                    App.utils.doc('#student-form').addEventListener('input', e => {
                        if (e.target.classList.contains('nota-input')) {
                            this.validateAndClampInput(e);
                            App.utils.debounce(() => this.updateFormTotals(), 400)();
                        }
                    });
                    App.utils.doc('#studentId').addEventListener('blur', this.validateMatriculaOnBlur.bind(this));
                    App.utils.doc('#clear-form-btn').addEventListener('click', () => this.clearForm());
                    App.utils.doc('#show-add-form-btn').addEventListener('click', () => this.showAddForm());
                    App.utils.doc('#studentsList').addEventListener('click', this.handleTableClick.bind(this));
                    App.utils.doc('#studentsTable thead').addEventListener('click', this.handleSort.bind(this));
                    App.utils.doc('#searchStudent').addEventListener('input', debouncedRenderStudents);
                    App.utils.doc('#aplicarConfig').addEventListener('click', this.handleConfigApply.bind(this));
                    App.utils.doc('#adicionarDisciplina').addEventListener('click', this.handleAddDisciplina.bind(this));
                    App.utils.doc('#disciplinasList').addEventListener('click', this.handleDisciplinaRemove.bind(this));
                    App.utils.doc('#bulkAddDisciplinas').addEventListener('click', this.handleBulkAddDisciplinas.bind(this));
                    App.utils.doc('#bimestreTabsContainer').addEventListener('click', e => {
                        if (e.target.matches('.bimestre-tab')) this.switchBimestreTab(e.target.dataset.bimestre);
                    });
                    App.utils.doc('#darkModeToggle').addEventListener('change', e => {
                        App.utils.doc('body').classList.toggle('dark-mode', e.target.checked);
                        localStorage.setItem(App.storage.KEYS.THEME, e.target.checked ? 'dark' : 'light');
                    });
                    App.utils.doc('#exportCSV').addEventListener('click', this.exportCSV.bind(this));
                    App.utils.doc('#backupData').addEventListener('click', this.backupData.bind(this));
                    App.utils.doc('#importData').addEventListener('click', () => App.utils.doc('#importFile').click());
                    App.utils.doc('#importFile').addEventListener('change', this.handleImport.bind(this));
                    App.utils.doc('#importBulkData').addEventListener('click', this.showBulkImportModal.bind(this));
                    App.utils.doc('#bulkDataInput').addEventListener('input', App.utils.debounce(() => this.handleBulkDataParse(), 300));
                    App.utils.doc('#importModalConfirm').addEventListener('click', () => this.confirmBulkImport());
                    App.utils.doc('#resetSystem').addEventListener('click', this.handleResetSystem.bind(this));
                    App.utils.doc('#printBoletim').addEventListener('click', () => window.print());
                    App.utils.doc('#reportSubject').addEventListener('change', () => this.updateAdvancedChart());
                    App.utils.docAll('.report-range-input').forEach(input => {
                        input.addEventListener('change', App.utils.debounce(() => this.handleReportRangeChange(), 400));
                    });
                    App.utils.docAll('.config-box input').forEach(el => el.addEventListener('input', () => this.updateConfigSummary()));
                },
                renderTurmaSelector() {
                    const select = App.utils.doc('#turmaSelect');
                    select.innerHTML = '';
                    const { turmas, activeTurmaId } = App.state;
                    for (const id in turmas) {
                        const option = document.createElement('option');
                        option.value = id; option.textContent = turmas[id].name;
                        if (id === activeTurmaId) option.selected = true;
                        select.appendChild(option);
                    }
                    const hasTurmas = Object.keys(turmas).length > 0;
                    App.utils.doc('#renameTurmaBtn').disabled = !hasTurmas;
                    App.utils.doc('#deleteTurmaBtn').disabled = !hasTurmas;
                },
                handleTurmaSelect(e) {
                    App.state.activeTurmaId = e.target.value;
                    localStorage.setItem(App.storage.KEYS.ACTIVE_TURMA_ID, App.state.activeTurmaId);
                    this.renderAll();
                },
                handleCreateTurma() {
                    const name = prompt("Digite o nome da nova turma:");
                    if (name && name.trim()) {
                        const newId = crypto.randomUUID();
                        App.state.turmas[newId] = App.storage.createDefaultTurma(name.trim());
                        App.state.activeTurmaId = newId;
                        App.storage.save();
                        this.renderAll();
                    }
                },
                handleRenameTurma() {
                    const activeTurma = App.getActiveTurma();
                    if (!activeTurma) return;
                    const newName = prompt("Digite o novo nome para a turma:", activeTurma.name);
                    if (newName && newName.trim()) {
                        activeTurma.name = newName.trim();
                        App.storage.save(); this.renderTurmaSelector();
                    }
                },
                handleDeleteTurma() {
                    const activeTurma = App.getActiveTurma();
                    if (!activeTurma) return;
                    if (Object.keys(App.state.turmas).length <= 1) return App.utils.showAlert("Voc√™ n√£o pode excluir a √∫ltima turma.", "error");
                    const action = () => {
                        delete App.state.turmas[App.state.activeTurmaId];
                        App.state.activeTurmaId = Object.keys(App.state.turmas)[0] || null;
                        App.storage.save(); this.renderAll();
                        App.utils.showAlert(`Turma "${activeTurma.name}" exclu√≠da!`);
                    };
                    App.utils.showModal('#modal', action);
                    App.utils.doc('#modalTitle').textContent = 'Excluir Turma';
                    App.utils.doc('#modalMessage').textContent = `Tem certeza que deseja excluir a turma "${activeTurma.name}"? TODOS os dados desta turma ser√£o perdidos permanentemente.`;
                },
                populateConfigForm() {
                    const activeTurma = App.getActiveTurma(); if (!activeTurma) return;
                    const { config } = activeTurma;
                    for (const key in config) {
                        if (key === 'reportRanges') {
                           config.reportRanges.forEach((val, i) => { const el = App.utils.doc(`#range${i + 1}`); if (el) el.value = val; });
                        }
                        else { 
                            const el = App.utils.doc(`#${key}`); if (el) el.value = config[key]; 
                        }
                    }
                },
                updateConfigSummary() {
                    const tempConfig = this.getTempConfig();
                    App.utils.doc('#approvalRuleSummary').innerHTML = `<strong>Regra de Aprova√ß√£o:</strong><br>
                    - M√≠nimo de <strong>${tempConfig.minPontosBimestre}</strong> pontos em CADA bimestre.<br>
                    - M√≠nimo de <strong>${tempConfig.minPontosAnual}</strong> pontos na SOMA FINAL do ano.`;
                },
                getTempConfig() {
                    return {
                        numBimestres: parseInt(App.utils.doc('#numBimestres').value) || 1, 
                        maxPontosDisciplina: parseFloat(App.utils.doc('#maxPontosDisciplina').value) || 0,
                        minPontosBimestre: parseFloat(App.utils.doc('#minPontosBimestre').value) || 0, 
                        minPontosAnual: parseFloat(App.utils.doc('#minPontosAnual').value) || 0,
                        reportRanges: Array.from(App.utils.docAll('.report-range-input')).map(el => parseFloat(el.value) || 0)
                    };
                },
                async handleConfigApply() {
                    const activeTurma = App.getActiveTurma(); if (!activeTurma) return;
                    const configBtn = App.utils.doc('#aplicarConfig');
                    const newConfig = this.getTempConfig();
                    const validationError = App.logic.validateConfig(newConfig);
                    if (validationError) return App.utils.showAlert(validationError, 'error');
                    if (JSON.stringify(activeTurma.config) === JSON.stringify(newConfig)) return App.utils.showAlert('Nenhuma configura√ß√£o foi alterada.', 'warning');
                    
                    const action = async () => {
                        App.utils.setButtonLoadingState(configBtn, true, 'Aplicando...');
                        await new Promise(resolve => setTimeout(resolve, 50));
                        const bimestresChanged = activeTurma.config.numBimestres !== newConfig.numBimestres;
                        if (bimestresChanged) {
                            activeTurma.students.forEach(student => {
                                if (newConfig.numBimestres < student.bimestres.length) student.bimestres.length = newConfig.numBimestres;
                                else while (student.bimestres.length < newConfig.numBimestres) student.bimestres.push({});
                            });
                        }
                        activeTurma.config = newConfig;
                        if (App.storage.save()) {
                            await App.utils.showButtonSuccessState(configBtn, 'Aplicado!');
                            App.utils.showAlert('Configura√ß√µes aplicadas e dados recalculados!', 'success');
                            this.renderAll();
                        } else { App.utils.setButtonLoadingState(configBtn, false); }
                    };

                    App.utils.showModal('#modal', action);
                    App.utils.doc('#modalTitle').textContent = 'Confirmar Mudan√ßa de Configura√ß√£o';
                    App.utils.doc('#modalMessage').textContent = 'Alterar as configura√ß√µes ir√° recalcular o status de todos os alunos. Continuar?';
                },
                renderStudents() {
                    const activeTurma = App.getActiveTurma(); if (!activeTurma) return;
                    const { config, students } = activeTurma;
                    const theadRow = App.utils.doc('#studentsTable thead tr');
                    const list = App.utils.doc('#studentsList');
                    theadRow.innerHTML = '';
                    let headersHTML = `<th data-sort="name">Nome</th><th data-sort="studentId">Matr√≠cula</th>`;
                    for (let i = 0; i < config.numBimestres; i++) headersHTML += `<th data-sort="bimestreTotals.${i}">${i + 1}¬∫ Bim. (Pontos)</th>`;
                    headersHTML += `<th data-sort="totalGeral">Total Anual</th><th data-sort="status.text">Status</th><th>A√ß√µes</th>`;
                    theadRow.innerHTML = headersHTML;
                    list.innerHTML = '';
                    const query = App.utils.doc('#searchStudent').value.toLowerCase();
                    const filtered = students.filter(s => s.name.toLowerCase().includes(query) || String(s.studentId).toLowerCase().includes(query));
                    const sorted = [...filtered].sort((a, b) => {
                        const get = (obj, path) => path.split('.').reduce((o, i) => (o ? o[i] : undefined), obj);
                        const valA = get(a, App.state.sort.column), valB = get(b, App.state.sort.column);
                        if (typeof valA === 'string') return App.state.sort.order === 'asc' ? valA.localeCompare(valB) : valB.localeCompare(valA);
                        return App.state.sort.order === 'asc' ? (valA || 0) - (valB || 0) : (valB || 0) - (valA || 0);
                    });
                    App.utils.doc('#emptyMessage').classList.toggle('hidden', sorted.length > 0);
                    sorted.forEach((s, index) => {
                        const row = list.insertRow();
                        let rowHTML = `
                            <td data-label="Nome">${s.name}</td>
                            <td data-label="Matr√≠cula">${s.studentId}</td>`;
                        for (let i = 0; i < config.numBimestres; i++) {
                            const totalBim = s.bimestreTotals[i] || 0;
                            rowHTML += `<td data-label="${i + 1}¬∫ Bim." style="color: ${totalBim < config.minPontosBimestre ? 'var(--danger)' : 'inherit'}">${totalBim.toFixed(1)}</td>`;
                        }
                        rowHTML += `
                            <td data-label="Total Anual">${s.totalGeral}</td>
                            <td data-label="Status" class="${s.status.class || ''}">${s.status.text}</td>
                            <td class="actions-cell">
                                <div class="actions">
                                    <button class="btn-small" data-action="boletim" data-index="${index}" title="Gerar Boletim">üìÑ</button>
                                    <button class="btn-small" data-action="details" data-index="${index}" title="Ver Gr√°fico">üìä</button>
                                    <button class="btn-small" data-action="edit" data-index="${index}" title="Editar">‚úèÔ∏è</button>
                                    <button class="btn-small btn-danger" data-action="delete" data-index="${index}" title="Excluir">üóëÔ∏è</button>
                                </div>
                            </td>`;
                        row.innerHTML = rowHTML;
                    });
                    App.utils.docAll('#studentsTable th').forEach(th => th.classList.remove('sort-asc', 'sort-desc'));
                    const activeSortHeader = App.utils.doc(`#studentsTable th[data-sort="${App.state.sort.column}"]`);
                    if(activeSortHeader) activeSortHeader.classList.add(App.state.sort.order === 'asc' ? 'sort-asc' : 'sort-desc');
                },
                renderFormStructure() {
                    const activeTurma = App.getActiveTurma(); if (!activeTurma) return;
                    const { numBimestres } = activeTurma.config;
                    const tabsContainer = App.utils.doc('#bimestreTabsContainer'), contentContainer = App.utils.doc('#bimestresContentContainer');
                    tabsContainer.innerHTML = ''; contentContainer.innerHTML = '';
                    if (activeTurma.disciplinas.length === 0) {
                        contentContainer.innerHTML = `<p class="alert alert-warning">Cadastre pelo menos uma disciplina para lan√ßar as notas.</p>`;
                        return;
                    }
                    for (let i = 0; i < numBimestres; i++) {
                        tabsContainer.innerHTML += `<div class="bimestre-tab ${i === 0 ? 'active' : ''}" data-bimestre="${i}">${i + 1}¬∫ Bimestre</div>`;
                        contentContainer.innerHTML += `<div id="bimestre${i}" class="bimestre-content ${i > 0 ? 'hidden' : ''}"><h3>üìä Notas do ${i + 1}¬∫ Bimestre</h3><div id="disciplinasBimestre${i}"></div></div>`;
                        this.renderDisciplinasInBimestre(i);
                    }
                },
                renderDisciplinasInBimestre(bimestreIndex) {
                    const activeTurma = App.getActiveTurma(); if (!activeTurma) return;
                    const container = App.utils.doc(`#disciplinasBimestre${bimestreIndex}`); if (!container) return;
                    container.innerHTML = '';

                    const { maxPontosDisciplina } = activeTurma.config;

                    activeTurma.disciplinas.forEach(nome => {
                        const id = App.utils.toId(nome);
                        const section = document.createElement('details'); section.className = 'disciplina-section'; section.open = true;
                        section.innerHTML = `<summary><h4>${nome}</h4></summary>
                        <div class="disciplina-content grid grid-2">
                            <div class="form-group">
                                <label for="${id}${bimestreIndex}_nota">Nota (M√°x: ${maxPontosDisciplina})</label>
                                <input type="number" id="${id}${bimestreIndex}_nota" class="nota-input" min="0" max="${maxPontosDisciplina}" step="0.1" value="0">
                            </div>
                            <div class="form-group">
                                <label for="${id}${bimestreIndex}_faltas">Faltas</label>
                                <input type="number" id="${id}${bimestreIndex}_faltas" class="nota-input" min="0" step="1" value="0">
                            </div>
                        </div>`;
                        container.appendChild(section);
                    });
                },
                updateFormTotals() {
                    const studentData = this.getFormData();
                    const { totalGeral, status } = App.logic.calculateTotalsAndStatus(studentData);
                    App.utils.doc(`#totalGeral`).value = totalGeral;
                    App.utils.doc(`#statusFinal`).value = status.text;
                    App.utils.doc(`#statusFinal`).className = `total-display ${status.class || ''}`;
                },
                validateAndClampInput(e) {
                    const input = e.target;
                    if (!input.value) return;
                    let value = parseFloat(input.value);
                    const min = parseFloat(input.min) ?? 0;
                    const max = parseFloat(input.max);
                    
                    if (input.id.includes('faltas')) {
                        if (value < min || !Number.isInteger(value)) input.value = Math.max(min, Math.floor(value) || 0);
                        return;
                    }
                    
                    if (!isNaN(max) && value > max) input.value = max;
                    if (value < min) input.value = min;
                },
                getFormData() {
                    const activeTurma = App.getActiveTurma();
                    const studentData = { bimestres: [], disciplinas: activeTurma.disciplinas };
                    if (!activeTurma) return studentData;
                    
                    const { config, disciplinas } = activeTurma;
                    
                    for (let i = 0; i < config.numBimestres; i++) {
                        studentData.bimestres[i] = {};
                        disciplinas.forEach(d => {
                            const id = App.utils.toId(d); const doc = App.utils.doc;
                            const nota = parseFloat(doc(`#${id}${i}_nota`)?.value) || 0;
                            const faltas = parseInt(doc(`#${id}${i}_faltas`)?.value) || 0;
                            const total = Math.min(nota, config.maxPontosDisciplina);
                            studentData.bimestres[i][id] = { total, faltas, nota };
                        });
                    }
                    studentData.name = App.utils.doc('#studentName').value.trim(); studentData.studentId = App.utils.doc('#studentId').value.trim();
                    return studentData;
                },
                async handleFormSubmit(e) {
                    e.preventDefault();
                    const activeTurma = App.getActiveTurma(); if (!activeTurma) return;
                    const btn = e.target.querySelector('button[type="submit"]');
                    App.utils.setButtonLoadingState(btn, true);
                    await new Promise(resolve => setTimeout(resolve, 50));
                    const studentData = this.getFormData();
                    const isEditing = !!App.state.studentToEdit;
                    const validation = App.logic.validateStudentData(studentData, isEditing);
                    if (!validation.valid) {
                        App.utils.showAlert(validation.message, 'error');
                        App.utils.setButtonLoadingState(btn, false);
                        return;
                    }
                    const metrics = App.logic.calculateTotalsAndStatus(studentData);
                    const finalStudent = { ...studentData, ...metrics };
                    if (isEditing) {
                        const studentIndex = activeTurma.students.findIndex(s => s.studentId === App.state.studentToEdit.studentId);
                        if (studentIndex > -1) activeTurma.students[studentIndex] = finalStudent;
                    } else activeTurma.students.push(finalStudent);
                    
                    if (App.storage.save()) {
                        App.utils.showAlert(`Aluno "${finalStudent.name}" ${isEditing ? 'atualizado' : 'cadastrado'}!`);
                        this.renderStudents(); this.updateStatistics(); this.renderAdvancedReports();
                        await App.utils.showButtonSuccessState(btn);
                        this.clearForm();
                    } else App.utils.setButtonLoadingState(btn, false);
                },
                clearForm() {
                    const form = App.utils.doc('#student-form'); form.reset(); form.classList.add('hidden');
                    App.utils.doc('#form-placeholder').classList.remove('hidden');
                    App.utils.doc('#studentId').classList.remove('is-invalid');
                    App.utils.doc('#studentId-validation').textContent = ''; App.state.studentToEdit = null;
                    this.updateFormTotals();
                },
                showAddForm() {
                    this.clearForm();
                    App.utils.doc('#student-form-title').textContent = 'üë®‚Äçüéì Adicionar Novo Aluno';
                    App.utils.doc('#form-placeholder').classList.add('hidden');
                    App.utils.doc('#student-form').classList.remove('hidden');
                    App.utils.doc('#submit-btn').innerHTML = 'üíæ <span class="btn-text">Salvar Novo Aluno</span>';
                    App.utils.doc('#student-management-card').scrollIntoView({ behavior: 'smooth' });
                },
                populateForm(student) {
                    const activeTurma = App.getActiveTurma(); if (!activeTurma) return;
                    this.clearForm(); App.state.studentToEdit = student; const doc = App.utils.doc;
                    doc('#student-form-title').textContent = `‚úèÔ∏è Editando: ${student.name}`;
                    doc('#studentName').value = student.name; doc('#studentId').value = student.studentId;
                    for (let i = 0; i < activeTurma.config.numBimestres; i++) {
                        activeTurma.disciplinas.forEach(d => {
                            const id = App.utils.toId(d); const nota = student.bimestres[i]?.[id] || {};
                            const notaInput = doc(`#${id}${i}_nota`);
                            if (notaInput) notaInput.value = nota.nota || 0;
                            const faltasInput = doc(`#${id}${i}_faltas`);
                            if (faltasInput) faltasInput.value = nota.faltas || 0;
                        });
                    }
                    this.updateFormTotals();
                    doc('#form-placeholder').classList.add('hidden');
                    doc('#student-form').classList.remove('hidden');
                    doc('#submit-btn').innerHTML = 'üíæ <span class="btn-text">Atualizar Aluno</span>';
                    doc('#student-management-card').scrollIntoView({ behavior: 'smooth' });
                },
                handleTableClick(e) {
                    const activeTurma = App.getActiveTurma(); if (!activeTurma) return;
                    const target = e.target.closest('button'); if (!target) return;
                    const action = target.dataset.action; const index = parseInt(target.dataset.index);
                    
                    const query = App.utils.doc('#searchStudent').value.toLowerCase();
                    const filtered = activeTurma.students.filter(s => s.name.toLowerCase().includes(query) || String(s.studentId).toLowerCase().includes(query));
                    const sorted = [...filtered].sort((a, b) => {
                        const get = (obj, path) => path.split('.').reduce((o, i) => (o ? o[i] : undefined), obj);
                        const valA = get(a, App.state.sort.column), valB = get(b, App.state.sort.column);
                        if (typeof valA === 'string') return App.state.sort.order === 'asc' ? valA.localeCompare(valB) : valB.localeCompare(valA);
                        return App.state.sort.order === 'asc' ? (valA || 0) - (valB || 0) : (valB || 0) - (valA || 0);
                    });
                    const student = sorted[index];
                    if (!student) return;

                    const originalIndex = activeTurma.students.findIndex(s => s.studentId === student.studentId);

                    switch (action) {
                        case 'edit': this.populateForm(student); break;
                        case 'delete':
                            App.utils.showModal('#modal', () => {
                                activeTurma.students.splice(originalIndex, 1);
                                if (App.storage.save()) { this.renderAll(); App.utils.showAlert(`"${student.name}" exclu√≠do!`); }
                            });
                            App.utils.doc('#modalTitle').textContent = 'Excluir Aluno';
                            App.utils.doc('#modalMessage').textContent = `Tem certeza que deseja excluir "${student.name}"?`;
                            break;
                        case 'details': this.showStudentDetails(student); break;
                        case 'boletim': this.showBoletim(student); break;
                    }
                },
                validateMatriculaOnBlur() {
                    const activeTurma = App.getActiveTurma(); if (!activeTurma) return;
                    const input = App.utils.doc('#studentId'); const validationMsg = App.utils.doc('#studentId-validation');
                    const studentId = input.value.trim();
                    if (!studentId) { input.classList.remove('is-invalid'); validationMsg.textContent = ''; return; }
                    const isDuplicate = activeTurma.students.some(s => s.studentId === studentId && s.studentId !== App.state.studentToEdit?.studentId);
                    input.classList.toggle('is-invalid', isDuplicate);
                    validationMsg.textContent = isDuplicate ? 'Esta matr√≠cula j√° est√° em uso.' : '';
                },
                handleSort(e) {
                    const column = e.target.dataset.sort; if (!column) return;
                    const { sort } = App.state;
                    sort.order = (sort.column === column && sort.order === 'asc') ? 'desc' : 'asc';
                    sort.column = column;
                    this.renderStudents();
                },
                switchBimestreTab(bimestreIndex) {
                    App.utils.docAll(`#bimestreTabsContainer .bimestre-tab`).forEach(t => t.classList.remove('active'));
                    App.utils.docAll(`#bimestresContentContainer .bimestre-content`).forEach(c => c.classList.add('hidden'));
                    App.utils.doc(`.bimestre-tab[data-bimestre="${bimestreIndex}"]`).classList.add('active');
                    App.utils.doc(`#bimestre${bimestreIndex}`).classList.remove('hidden');
                },
                updateStatistics() {
                    const activeTurma = App.getActiveTurma(); if (!activeTurma) return;
                    const total = activeTurma.students.length;
                    const approved = activeTurma.students.filter(s => s.status.text === 'Aprovado').length;
                    App.utils.doc('#totalStudents').textContent = total;
                    App.utils.doc('#approvedStudents').textContent = approved;
                    App.utils.doc('#failedStudents').textContent = total - approved;
                },
                showStudentDetails(student) {
                    const activeTurma = App.getActiveTurma(); if (!activeTurma) return;
                    if (typeof Chart === 'undefined') return App.utils.showAlert('Gr√°fico indispon√≠vel offline.', 'error');
                    App.utils.doc('#detailsModalTitle').textContent = `Desempenho de: ${student.name}`;
                    App.utils.doc('#detailsModalSubtitle').textContent = `Pontua√ß√£o Total: ${student.totalGeral} | Status: ${student.status.text}`;
                    const { config, disciplinas } = activeTurma; const labels = disciplinas;
                    const data = labels.map(d => { let total = 0; const id = App.utils.toId(d); for (let i = 0; i < config.numBimestres; i++) total += student.bimestres[i]?.[id]?.total || 0; return total; });
                    
                    const maxScorePerSubjectTotal = config.maxPontosDisciplina * config.numBimestres;

                    if (App.state.charts.studentChart) App.state.charts.studentChart.destroy();
                    const ctx = App.utils.doc('#studentChart').getContext('2d');
                    App.state.charts.studentChart = new Chart(ctx, { type: 'bar', data: { labels, datasets: [{ label: 'Pontua√ß√£o Total', data, backgroundColor: '#F2C94C' }] }, options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, max: maxScorePerSubjectTotal > 0 ? maxScorePerSubjectTotal : 100 } }, plugins: { legend: { display: false } } } });
                    App.utils.showModal('#detailsModal');
                },
                showBoletim(student) {
                    const activeTurma = App.getActiveTurma(); if (!activeTurma) return;
                    const { config, disciplinas } = activeTurma;
                    
                    let content = `<h3>Boletim - ${student.name}</h3><p><strong>Matr√≠cula:</strong> ${student.studentId}</p><table><thead><tr><th>Disciplina</th>`;
                    for (let i = 0; i < config.numBimestres; i++) content += `<th>${i + 1}¬∫ Bim. (Pontos)</th>`;
                    content += `<th>Total (Pontos)</th></tr></thead><tbody>`;
                    
                    disciplinas.forEach(d => { 
                        let totalDisc = 0; const id = App.utils.toId(d); 
                        content += `<tr><td>${d}</td>`; 
                        for (let i = 0; i < config.numBimestres; i++) { 
                            const nota = student.bimestres[i]?.[id]?.total || 0; 
                            totalDisc += nota; 
                            content += `<td>${nota.toFixed(1)}</td>`; 
                        } 
                        content += `<td><strong>${totalDisc.toFixed(1)}</strong></td></tr>`; 
                    });
                    
                    content += `</tbody><tfoot><tr><td><strong>TOTAIS DO BIMESTRE</strong></td>`;
                    student.bimestreTotals.forEach(total => {
                        content += `<td><strong>${total.toFixed(1)}</strong></td>`;
                    });
                    content += `<td><strong>${student.totalGeral}</strong></td>`;
                    content += `</tr></tfoot></table><br><strong>Total de Pontos Anual: ${student.totalGeral}</strong><br><strong>Status Final: ${student.status.text}</strong>`;
                    App.utils.doc('#boletimContent').innerHTML = content; App.utils.showModal('#boletimModal');
                },
                renderAdvancedReports() {
                    const activeTurma = App.getActiveTurma(); if (!activeTurma) return;
                    const select = App.utils.doc('#reportSubject');
                    select.innerHTML = activeTurma.disciplinas.map(d => `<option value="${d}">${d}</option>`).join('');
                    if (activeTurma.disciplinas.length > 0) this.updateAdvancedChart();
                },
                handleReportRangeChange() {
                    const activeTurma = App.getActiveTurma(); if (!activeTurma) return;
                    const ranges = Array.from(App.utils.docAll('.report-range-input')).map(el => parseFloat(el.value));
                    for (let i = 0; i < ranges.length - 1; i++) if (ranges[i] >= ranges[i + 1]) { ranges[i + 1] = ranges[i] + 1; App.utils.doc(`#range${i + 2}`).value = ranges[i + 1]; }
                    activeTurma.config.reportRanges = ranges; App.storage.save(); this.updateAdvancedChart();
                },
                updateAdvancedChart() {
                    const activeTurma = App.getActiveTurma(); if (!activeTurma || typeof Chart === 'undefined') return;
                    const subjectName = App.utils.doc('#reportSubject').value; if (!subjectName) return;
                    const subjectId = App.utils.toId(subjectName); const { config, students, disciplinas } = activeTurma;
                    const rangesConfig = config.reportRanges; const labels = [`0-${rangesConfig[0]}%`, ...rangesConfig.slice(0, -1).map((r, i) => `${r + 1}-${rangesConfig[i + 1]}%`)];
                    const ranges = labels.reduce((acc, label) => ({ ...acc, [label]: 0 }), {});
                    
                    const maxScoreTotal = config.maxPontosDisciplina * config.numBimestres;

                    if (maxScoreTotal > 0) {
                        students.forEach(s => { let totalNota = 0; for (let i = 0; i < config.numBimestres; i++) totalNota += s.bimestres[i]?.[subjectId]?.total || 0; const percent = (totalNota / maxScoreTotal) * 100; for (let i = 0; i < rangesConfig.length; i++) { const prevRange = i > 0 ? rangesConfig[i-1] : 0; if (percent > prevRange && percent <= rangesConfig[i]) { ranges[labels[i]]++; break; } } });
                    }
                    if (App.state.charts.advancedReportChart) App.state.charts.advancedReportChart.destroy();
                    App.state.charts.advancedReportChart = new Chart(App.utils.doc('#advancedReportChart').getContext('2d'), { type: 'bar', data: { labels: Object.keys(ranges), datasets: [{ label: `Alunos por faixa de nota`, data: Object.values(ranges), backgroundColor: ['#D73A49', '#F2994A', '#F2C94C', '#28A745', '#218838'] }] }, options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } }, plugins: { legend: { display: false } } } });
                },
                renderDisciplinasConfig() {
                    const activeTurma = App.getActiveTurma(); if (!activeTurma) return;
                    const list = App.utils.doc('#disciplinasList'); list.innerHTML = '';
                    activeTurma.disciplinas.forEach(d => { list.innerHTML += `<span class="disciplina-tag">${d}<button data-disciplina="${d}" title="Remover">√ó</button></span>`; });
                    this.updateConfigSummary();
                },
                handleAddDisciplina() {
                    const activeTurma = App.getActiveTurma(); if (!activeTurma) return;
                    const input = App.utils.doc('#novaDisciplina'); const nome = input.value.trim(); if (!nome) return;
                    if (activeTurma.disciplinas.map(d => d.toLowerCase()).includes(nome.toLowerCase())) return App.utils.showAlert('Essa disciplina j√° existe.', 'warning');
                    const action = () => { activeTurma.disciplinas.push(nome); if (App.storage.save()) { App.utils.showAlert('Disciplina adicionada!'); this.renderAll(); input.value = ''; } };
                    if (activeTurma.students.length > 0) { App.utils.showModal('#modal', action); App.utils.doc('#modalTitle').textContent = 'Adicionar Disciplina'; App.utils.doc('#modalMessage').textContent = 'Adicionar uma nova disciplina ir√° afetar todos os alunos cadastrados. Continuar?'; } else action();
                },
                handleDisciplinaRemove(e) {
                    const activeTurma = App.getActiveTurma(); if (!activeTurma || !e.target.dataset.disciplina) return;
                    const nome = e.target.dataset.disciplina;
                    const action = () => { activeTurma.disciplinas = activeTurma.disciplinas.filter(d => d !== nome); if (App.storage.save()) { App.utils.showAlert('Disciplina removida!'); this.renderAll(); } };
                    if (activeTurma.students.length > 0) { App.utils.showModal('#modal', action); App.utils.doc('#modalTitle').textContent = 'Remover Disciplina'; App.utils.doc('#modalMessage').textContent = `Remover "${nome}" ir√° apagar todas as notas associadas a ela em todos os alunos desta turma. Continuar?`; } else action();
                },
                handleBulkAddDisciplinas() {
                    const activeTurma = App.getActiveTurma(); if (!activeTurma) return;
                    const modal = App.utils.doc('#disciplinasModal'); modal.querySelector('textarea').value = activeTurma.disciplinas.join('\n');
                    const confirmAction = () => { const novasDisciplinas = modal.querySelector('textarea').value.split('\n').map(d => d.trim()).filter(Boolean); const finalAction = () => { activeTurma.disciplinas = novasDisciplinas; if (App.storage.save()) { App.utils.showAlert('Lista de disciplinas atualizada!'); this.renderAll(); } }; if (activeTurma.students.length > 0) { App.utils.showModal('#modal', finalAction); App.utils.doc('#modalTitle').textContent = 'Atualizar Disciplinas'; App.utils.doc('#modalMessage').textContent = 'Alterar a lista de disciplinas ir√° afetar todos os alunos e pode remover dados. Continuar?'; } else finalAction(); };
                    App.utils.showModal('#disciplinasModal', confirmAction);
                },
                exportCSV() {
                    const activeTurma = App.getActiveTurma(); if (!activeTurma) return;
                    const { config, disciplinas, students } = activeTurma; let csvContent = "data:text/csv;charset=utf-8,"; let headers = ['Matricula', 'Nome'];
                    for (let i = 0; i < config.numBimestres; i++) disciplinas.forEach(d => headers.push(`${d}_Nota_Bim${i + 1}`, `${d}_Faltas_Bim${i + 1}`));
                    headers.push('Total_Pontos', 'Status'); csvContent += headers.join(';') + '\r\n';
                    students.forEach(s => { let row = [`"${s.studentId}"`, `"${s.name}"`]; for (let i = 0; i < config.numBimestres; i++) disciplinas.forEach(d => { const nota = s.bimestres[i]?.[App.utils.toId(d)]; row.push(nota?.nota || 0); row.push(nota?.faltas || 0); }); row.push(s.totalGeral, s.status.text); csvContent += row.join(';') + '\r\n'; });
                    const link = document.createElement("a"); link.setAttribute("href", encodeURI(csvContent)); link.setAttribute("download", `export_turma_${activeTurma.name}.csv`); link.click(); link.remove();
                },
                backupData() {
                    const activeTurma = App.getActiveTurma(); if (!activeTurma) return;
                    const blob = new Blob([JSON.stringify(activeTurma, null, 2)], { type: 'application/json' });
                    const link = document.createElement('a'); link.href = URL.createObjectURL(blob);
                    link.download = `backup_turma_${activeTurma.name}_${new Date().toISOString().slice(0, 10)}.json`;
                    link.click(); URL.revokeObjectURL(link.href);
                },
                handleImport(e) {
                    const file = e.target.files[0]; if (!file) return; const reader = new FileReader();
                    reader.onload = (event) => { try { const data = JSON.parse(event.target.result); if (data.students && data.disciplinas && data.config) { App.utils.showModal('#modal', () => { const newId = data.id || crypto.randomUUID(); App.state.turmas[newId] = data; App.state.activeTurmaId = newId; if (App.storage.save()) { App.utils.showAlert(`Backup importado como nova turma: "${data.name}"!`); this.renderAll(); } }); App.utils.doc('#modalTitle').textContent = 'Importar Backup de Turma'; App.utils.doc('#modalMessage').textContent = 'Isto ir√° adicionar os dados do arquivo como uma NOVA TURMA. Continuar?'; } else { App.utils.showAlert('Arquivo de backup inv√°lido.', 'error'); } } catch (err) { App.utils.showAlert('Erro ao ler o arquivo.', 'error'); } };
                    reader.readAsText(file); e.target.value = '';
                },
                showBulkImportModal() {
                    const activeTurma = App.getActiveTurma(); if (!activeTurma) return;
                    const { config, disciplinas } = activeTurma; let headers = ['Matr√≠cula', 'Nome'];
                    for (let i = 0; i < config.numBimestres; i++) disciplinas.forEach(d => headers.push(`${d} (Nota Bim ${i + 1})`, `${d} (Faltas Bim ${i + 1})`));
                    App.utils.doc('#importInstructions').innerHTML = `<p><strong>Formato (${headers.length} colunas):</strong><br>${headers.join('; ')}</p>`;
                    App.utils.doc('#importPreview').innerHTML = ''; App.utils.doc('#bulkDataInput').value = ''; App.utils.doc('#importModalConfirm').disabled = true;
                    App.utils.showModal('#importModal');
                },
                handleBulkDataParse() {
                    const activeTurma = App.getActiveTurma(); if (!activeTurma) return;
                    const text = App.utils.doc('#bulkDataInput').value.trim(); const lines = text.split('\n').filter(Boolean);
                    const { config, disciplinas } = activeTurma; const expectedCols = 2 + (disciplinas.length * 2 * config.numBimestres);
                    App.state.parsedStudents = []; let previewHtml = '<table><tr><th>Matr√≠cula</th><th>Nome</th><th>Status</th></tr>'; let hasErrors = false;
                    lines.forEach(line => { const cols = line.split(';'); if (cols.length !== expectedCols) { previewHtml += `<tr class="error-row"><td>${cols[0] || ''}</td><td>${cols[1] || ''}</td><td>Erro: ${cols.length} colunas encontradas, ${expectedCols} esperadas.</td></tr>`; hasErrors = true; return; } const [studentId, name, ...notasFaltas] = cols; const student = { studentId, name, bimestres: Array.from({ length: config.numBimestres }, () => ({})) }; for (let i = 0; i < config.numBimestres; i++) { for (let j = 0; j < disciplinas.length; j++) { let nota = parseFloat(notasFaltas[(i * disciplinas.length * 2) + (j * 2)]?.replace(',', '.')) || 0; nota = Math.min(nota, config.maxPontosDisciplina); const faltas = parseInt(notasFaltas[(i * disciplinas.length * 2) + (j * 2) + 1]) || 0; student.bimestres[i][App.utils.toId(disciplinas[j])] = { nota, total: nota, faltas }; } } App.state.parsedStudents.push(student); previewHtml += `<tr><td>${studentId}</td><td>${name}</td><td>Pronto para importar</td></tr>`; });
                    previewHtml += '</table>'; App.utils.doc('#importPreview').innerHTML = previewHtml; App.utils.doc('#importModalConfirm').disabled = hasErrors || App.state.parsedStudents.length === 0;
                },
                confirmBulkImport() {
                    const activeTurma = App.getActiveTurma(); if (!activeTurma || App.state.parsedStudents.length === 0) return;
                    App.utils.doc('#importModal').classList.remove('visible');
                    App.utils.showModal('#modal', () => { activeTurma.students.push(...App.state.parsedStudents); if (App.storage.save()) { App.utils.showAlert(`${App.state.parsedStudents.length} aluno(s) importado(s)!`); this.renderAll(); } });
                    App.utils.doc('#modalTitle').textContent = 'Confirmar Importa√ß√£o'; App.utils.doc('#modalMessage').textContent = `Adicionar ${App.state.parsedStudents.length} novo(s) aluno(s) √† turma atual?`;
                },
                handleResetSystem() {
                    const activeTurma = App.getActiveTurma(); if (!activeTurma) return;
                    App.utils.showModal('#modal', () => { activeTurma.students = []; activeTurma.disciplinas = ['Portugu√™s', 'Matem√°tica']; if(App.storage.save()) { App.utils.showAlert(`Dados da turma "${activeTurma.name}" resetados!`); this.renderAll(); } });
                    App.utils.doc('#modalTitle').textContent = 'Resetar Dados da Turma'; App.utils.doc('#modalMessage').textContent = 'Isto ir√° apagar TODOS os alunos e disciplinas da turma ATIVA. Continuar?';
                }
            },
            init() { this.storage.load(); this.view.init(); }
        };
        App.init();
    });
    </script>
</body>
</html>

