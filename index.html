<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NotaSys Pro - Gest√£o Acad√™mica</title>
    <!-- Favicon SVG para melhor qualidade e customiza√ß√£o -->
    <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%23F2C94C'%3E%3Cpath d='M12 3L1 9l11 6 9-4.91V17h2V9L12 3zm0 8.69L3.41 7.09 12 5.31l8.59 1.78L12 11.69z M5 13.18V17.5h14v-4.32l-7 3.11-7-3.11z'/%3E%3C/svg%3E">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <!-- Biblioteca de gr√°ficos Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* Paleta de Cores e Vari√°veis Globais */
        :root {
            --primary: #F2C94C; --primary-dark: #E0B849;
            --success: #28A745; --success-dark: #218838;
            --danger: #D73A49; --danger-dark: #B02A37;
            --warning: #F2994A; --warning-dark: #E68A42;
            --light-bg: #F7F9FC; --light-card: #FFFFFF; --light-border: #E1E4E8;
            --light-text: #242A31; --light-text-secondary: #6A737D; --light-shadow: rgba(36, 42, 49, 0.1);
            --dark-bg: #1C2128; --dark-card: #22272E; --dark-border: #373E47;
            --dark-text: #E6EDF3; --dark-text-secondary: #909DAB; --dark-shadow: rgba(0, 0, 0, 0.3);
            --bg-color: var(--light-bg); --card-color: var(--light-card); --border-color: var(--light-border);
            --text-color: var(--light-text); --text-secondary-color: var(--light-text-secondary); --shadow-color: var(--light-shadow);
        }
        /* Estilos para o Modo Escuro */
        .dark-mode {
            --bg-color: var(--dark-bg); --card-color: var(--dark-card); --border-color: var(--dark-border);
            --text-color: var(--dark-text); --text-secondary-color: var(--dark-text-secondary); --shadow-color: var(--dark-shadow);
        }
        /* Reset e Estilos Base */
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', 'Segoe UI', sans-serif; }
        html { scroll-behavior: smooth; font-size: 16px; }
        body { background-color: var(--bg-color); color: var(--text-color); line-height: 1.6; padding: 20px; transition: background-color 0.3s, color 0.3s; -webkit-text-size-adjust: 100%; }
        .container { max-width: 1400px; margin: 0 auto; }
        /* Componentes da UI */
        .header-controls { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        header { background: linear-gradient(135deg, var(--primary), var(--primary-dark)); color: var(--light-text); padding: 20px; border-radius: 12px; margin-bottom: 30px; box-shadow: 0 6px 12px var(--shadow-color); text-align: center; }
        header h1 { font-size: 2.5rem; margin-bottom: 10px; }
        header p { font-size: 1.1rem; opacity: 0.9; }
        .card { background: var(--card-color); border-radius: 12px; padding: 25px; margin-bottom: 25px; box-shadow: 0 4px 8px var(--shadow-color); transition: background-color 0.3s; }
        .card h2 { color: var(--primary); margin-bottom: 20px; padding-bottom: 10px; border-bottom: 1px solid var(--border-color); }
        .form-group { margin-bottom: 20px; }
        label { display: block; margin-bottom: 8px; font-weight: 600; color: var(--text-color); }
        input, select, textarea { width: 100%; padding: 12px 15px; border: 1px solid var(--border-color); background-color: var(--bg-color); color: var(--text-color); border-radius: 8px; font-size: 1rem; transition: all 0.3s; }
        textarea { min-height: 150px; font-family: monospace; }
        input:focus, select:focus, textarea:focus { border-color: var(--primary); outline: none; box-shadow: 0 0 0 3px rgba(242, 201, 76, 0.25); }
        input.is-invalid { border-color: var(--danger); } .validation-message { color: var(--danger); font-size: 0.9rem; margin-top: 5px; }
        button { background-color: var(--primary); color: #fff; border: none; padding: 12px 20px; border-radius: 8px; cursor: pointer; font-size: 1rem; font-weight: 600; transition: all 0.2s; margin: 5px; }
        button.btn-primary { color: var(--light-text); }
        button:hover { transform: translateY(-2px); box-shadow: 0 4px 8px var(--shadow-color); }
        button:disabled { background-color: #95a5a6; cursor: not-allowed; transform: none; box-shadow: none; }
        .btn-success { background-color: var(--success); } .btn-success:hover { background-color: var(--success-dark); }
        .btn-danger { background-color: var(--danger); } .btn-danger:hover { background-color: var(--danger-dark); }
        .btn-warning { background-color: var(--warning); } .btn-warning:hover { background-color: var(--warning-dark); }
        .btn-secondary { background-color: var(--text-secondary-color); } .btn-secondary:hover { background-color: var(--text-color); }
        .btn-small { padding: 8px 12px; font-size: 0.9rem; }
        .grid { display: grid; gap: 20px; } .grid-2 { grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); }
        .grid-3 { grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); } .grid-5 { grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); }
        .table-responsive { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { padding: 14px 16px; text-align: left; border-bottom: 1px solid var(--border-color); white-space: nowrap; }
        th { background-color: var(--bg-color); color: var(--text-color); font-weight: 600; cursor: pointer; user-select: none; }
        th:hover { color: var(--primary); }
        .sort-asc::after { content: ' ‚ñ≤'; } .sort-desc::after { content: ' ‚ñº'; }
        tr:hover { background-color: rgba(242, 201, 76, 0.07); }
        .status-Aprovado { color: var(--success); font-weight: 600; } .status-Reprovado { color: var(--danger); font-weight: 600; }
        .stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; }
        .stat-card { background: var(--card-color); border-radius: 12px; padding: 20px; text-align: center; }
        .stat-value { font-size: 2.5rem; font-weight: 700; margin: 10px 0; }
        .stat-aprovados { color: var(--success); } .stat-reprovados { color: var(--danger); }
        .actions { display: flex; flex-wrap: wrap; gap: 10px; }
        .hidden { display: none !important; }
        .disciplina-section { margin-bottom: 10px; border: 1px solid var(--border-color); border-radius: 12px; }
        .disciplina-section summary { background: var(--bg-color); padding: 15px; border-radius: 8px; cursor: pointer; list-style: none; font-weight: 600; }
        .disciplina-section summary::-webkit-details-marker { display: none; }
        .disciplina-section[open] summary { border-bottom-left-radius: 0; border-bottom-right-radius: 0; background: var(--primary); color: var(--light-text); }
        .disciplina-content { padding: 20px; }
        .bimestre-tabs { display: flex; margin-bottom: 20px; border-bottom: 2px solid var(--border-color); flex-wrap: wrap; }
        .bimestre-tab { padding: 10px 20px; cursor: pointer; border-bottom: 3px solid transparent; }
        .bimestre-tab.active { border-bottom: 3px solid var(--primary); color: var(--primary); font-weight: 600; }
        .total-display { background-color: var(--bg-color); font-weight: 600; color: var(--text-color); }
        .config-box { border: 1px solid var(--border-color); border-radius: 8px; padding: 15px; margin-bottom: 20px; }
        #approvalRuleSummary { background-color: #FFF9E6; border-left: 5px solid var(--primary); padding: 15px; margin-top: 10px; font-weight: 600; color: #B89007; border-radius: 5px; }
        .dark-mode #approvalRuleSummary { background-color: rgba(242, 201, 76, 0.1); color: var(--dark-text-secondary); border-left-color: var(--primary);}
        .alert { padding: 15px; border-radius: 8px; margin: 10px 0; font-weight: 600; border: 1px solid transparent; }
        .alert-success { background: #d4edda; color: #155724; border-color: #c3e6cb; }
        .alert-error { background: #f8d7da; color: #721c24; border-color: #f5c6cb; }
        .alert-warning { background: #fff3cd; color: #856404; border-color: #ffeeba; }
        .dark-mode .alert-success { background-color: #1e4620; color: #a3d9a5; border-color: #2e6b30; }
        .dark-mode .alert-error { background-color: #58151c; color: #f1b0b7; border-color: #842029; }
        .dark-mode .alert-warning { background-color: #664d03; color: #ffda6a; border-color: #997404; }
        .add-disciplina-section { background: var(--bg-color); border: 2px dashed var(--success); border-radius: 12px; padding: 20px; text-align: center; margin-bottom: 20px; }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.6); display: flex; justify-content: center; align-items: center; z-index: 1000; opacity: 0; visibility: hidden; transition: opacity 0.3s, visibility 0.3s; }
        .modal-overlay.visible { opacity: 1; visibility: visible; }
        .modal { background: var(--card-color); padding: 30px; border-radius: 12px; width: 90%; max-width: 500px; text-align: center; transform: scale(0.9); transition: transform 0.3s; }
        .modal-overlay.visible .modal { transform: scale(1); }
        #detailsModal .modal, #boletimModal .modal, #importModal .modal, #disciplinasModal .modal { max-width: 800px; text-align: left; }
        .modal h3 { margin-bottom: 15px; color: var(--primary); }
        .modal p { margin-bottom: 25px; color: var(--text-secondary-color); }
        .modal-buttons { display: flex; justify-content: center; gap: 15px; }
        .theme-switch-wrapper { display: flex; align-items: center; gap: 10px; }
        .theme-switch { display: inline-block; height: 24px; position: relative; width: 48px; }
        .theme-switch input { display:none; }
        .slider { background-color: #ccc; bottom: 0; cursor: pointer; left: 0; position: absolute; right: 0; top: 0; transition: .4s; border-radius: 24px; }
        .slider:before { background-color: #fff; bottom: 2px; content: ""; height: 20px; left: 2px; position: absolute; transition: .4s; width: 20px; border-radius: 50%; }
        input:checked + .slider { background-color: var(--primary); }
        input:checked + .slider:before { transform: translateX(24px); }
        .chart-container { position: relative; height: 300px; width: 100%; margin-top: 20px; }
        #boletimContent, #importPreview { text-align: left; }
        #boletimContent table, #importPreview table { width: 100%; margin-top: 15px; }
        #boletimContent th, #boletimContent td, #importPreview th, #importPreview td { padding: 8px; border: 1px solid var(--border-color); }
        #importInstructions { padding: 15px; background: var(--bg-color); border-radius: 8px; margin-bottom: 15px; font-size: 0.9em; word-break: break-all; }
        #importPreview tr.error-row { background-color: rgba(215, 58, 73, 0.1); }
        #disciplinasList { display: flex; flex-wrap: wrap; gap: 10px; padding: 10px; background: var(--bg-color); border-radius: 8px; }
        .disciplina-tag { background: var(--primary); color: var(--light-text); padding: 5px 10px; border-radius: 15px; display: flex; align-items: center; gap: 8px; font-size: 0.9rem; }
        .disciplina-tag button { background: none; border: none; color: inherit; cursor: pointer; padding: 0; margin: 0; font-size: 1.1rem; line-height: 1; }
        #student-form.hidden { max-height: 0; overflow: hidden; padding-top: 0; padding-bottom: 0; margin-top: 0; margin-bottom: 0; opacity: 0; transform: translateY(-20px); transition: all 0.5s ease-in-out; }
        #student-form { max-height: 5000px; overflow: hidden; opacity: 1; transform: translateY(0); transition: all 0.5s ease-in-out; }
        /* Media Queries para Responsividade */
        @media (max-width: 768px) {
            html { font-size: 14px; } body { padding: 10px; } header h1 { font-size: 1.8rem; }
            .card { padding: 15px; } .grid-2, .grid-3, .grid-5 { grid-template-columns: 1fr; }
            .header-controls { flex-direction: column; gap: 15px; align-items: center; }
            button, input, select, textarea { font-size: 1rem; padding: 10px 12px; }
        }
        /* Estilos de Impress√£o */
        @media print { 
            body * { visibility: hidden; } #boletimModal, #boletimModal * { visibility: visible; } 
            #boletimModal { position: absolute; left: 0; top: 0; width: 100%; height: 100%; } 
            #boletimModal .modal-buttons { display: none; } #boletimModal .modal { box-shadow: none; border: 1px solid #000; } 
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>NotaSys Pro</h1>
            <p>Sistema de Gest√£o Acad√™mica Refatorado e Corrigido</p>
        </header>

        <div class="header-controls">
            <div class="theme-switch-wrapper">
                <span>‚òÄÔ∏è</span>
                <label class="theme-switch" for="darkModeToggle">
                    <input type="checkbox" id="darkModeToggle" />
                    <span class="slider round"></span>
                </label>
                <span>üåô</span>
            </div>
        </div>

        <div id="alertContainer" role="status" aria-live="polite"></div>
        
        <div class="card">
            <h2>‚öôÔ∏è Configura√ß√£o da Turma</h2>
            <div class="grid grid-2">
                <div class="config-box">
                    <h3>üóìÔ∏è Estrutura do Ano Letivo</h3>
                    <div class="form-group"><label for="numBimestres">N√∫mero de Bimestres</label><input type="number" id="numBimestres" min="1" max="4" value="1"></div>
                    <h3>üíØ Pontua√ß√£o por Disciplina (em cada bimestre)</h3>
                    <div class="grid grid-3">
                        <div class="form-group"><label for="maxAtividade">Atividades</label><input type="number" id="maxAtividade" min="0" step="0.1" value="0"></div>
                        <div class="form-group"><label for="maxTrabalho">Trabalhos</label><input type="number" id="maxTrabalho" min="0" step="0.1" value="0"></div>
                        <div class="form-group"><label for="maxProva">Prova</label><input type="number" id="maxProva" min="0" step="0.1" value="10"></div>
                    </div>
                </div>
                <div class="config-box">
                    <h3>üìä Crit√©rios de Aprova√ß√£o</h3>
                    <div class="form-group"><label for="minNotaBimestre">Nota M√≠nima POR DISCIPLINA em cada bimestre</label><input type="number" id="minNotaBimestre" min="0" step="0.1" value="6"></div>
                    <div class="form-group"><label for="minNotaTotal">Nota M√≠nima ANUAL (soma de todos)</label><input type="number" id="minNotaTotal" min="0" step="0.1" value="60"></div>
                    <div id="approvalRuleSummary"></div>
                </div>
            </div>
            <button id="aplicarConfig" class="btn-success">üíæ Aplicar Configura√ß√µes</button>
        </div>

        <div class="card">
            <h2>üìö Disciplinas da Turma</h2>
            <label>Disciplinas Atuais:</label>
            <div id="disciplinasList"></div>
            <div class="add-disciplina-section">
                <div class="grid grid-2">
                    <div class="form-group"><label for="novaDisciplina">Adicionar Nova Disciplina</label><input type="text" id="novaDisciplina" placeholder="Ex: Hist√≥ria"></div>
                    <div class="form-group" style="align-self: end;"><button type="button" id="adicionarDisciplina" class="btn-success">‚ûï Adicionar</button></div>
                </div>
            </div>
            <div class="actions"><button id="bulkAddDisciplinas" class="btn-primary">Adicionar em Massa</button></div>
        </div>
        
        <div id="student-management-card" class="card">
            <h2 id="student-form-title">Gest√£o de Alunos</h2>
            <p id="form-placeholder" class="alert">Selecione um aluno na lista abaixo para ver ou editar as suas notas, ou clique em 'Adicionar Novo Aluno'.</p>
            <form id="student-form" class="hidden">
                 <div class="grid grid-2">
                    <div class="form-group">
                        <label for="studentName">Nome *</label><input type="text" id="studentName" required>
                    </div>
                    <div class="form-group">
                        <label for="studentId">Matr√≠cula *</label><input type="text" id="studentId" required>
                        <div id="studentId-validation" class="validation-message"></div>
                    </div>
                </div>
                <div class="bimestre-tabs" id="bimestreTabsContainer"></div>
                <div id="bimestresContentContainer"></div>
                <div class="grid grid-2" style="margin-top: 20px;">
                    <div class="form-group"><label for="totalGeral">Total Anual (Soma de Todas as Disciplinas)</label><input type="text" id="totalGeral" class="total-display" readonly></div>
                    <div class="form-group"><label for="statusFinal">Status Final</label><input type="text" id="statusFinal" class="total-display" readonly></div>
                </div>
                <div class="form-group">
                    <button type="submit" id="submit-btn" class="btn-success">üíæ Salvar</button>
                    <button type="button" id="clear-form-btn" class="btn-danger">üóëÔ∏è Cancelar</button>
                </div>
            </form>
        </div>
        
        <div class="card">
            <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px;">
                <h2>üìã Lista de Alunos</h2>
                <button id="show-add-form-btn" class="btn-success">‚ûï Adicionar Novo Aluno</button>
            </div>
            <div class="form-group"><label for="searchStudent">üîé Buscar por Nome ou Matr√≠cula</label><input type="text" id="searchStudent" placeholder="Digite para buscar..."></div>
            <div class="table-responsive">
                <table id="studentsTable">
                    <thead>
                        <tr>
                            <!-- O CABE√áALHO SER√Å GERADO DINAMICAMENTE PELO JAVASCRIPT -->
                        </tr>
                    </thead>
                    <tbody id="studentsList"></tbody>
                </table>
            </div>
            <div id="emptyMessage" class="alert hidden">Nenhum aluno cadastrado.</div>
        </div>

        <div class="card">
            <h2>üìà Relat√≥rios Avan√ßados</h2>
            <div class="grid grid-2">
                <div class="form-group"><label for="reportSubject">Analisar Desempenho em:</label><select id="reportSubject"></select></div>
                <div class="form-group">
                    <label>Faixas de Desempenho (%)</label>
                    <div class="grid" style="grid-template-columns: repeat(5, 1fr); gap: 10px;">
                        <input type="number" class="report-range-input" id="range1" value="20" min="0" max="100">
                        <input type="number" class="report-range-input" id="range2" value="40" min="0" max="100">
                        <input type="number" class="report-range-input" id="range3" value="60" min="0" max="100">
                        <input type="number" class="report-range-input" id="range4" value="80" min="0" max="100">
                        <input type="number" class="report-range-input" id="range5" value="100" min="0" max="100" readonly>
                    </div>
                </div>
            </div>
            <div class="chart-container"><canvas id="advancedReportChart"></canvas></div>
        </div>
        <div class="card">
            <h2>üìä Estat√≠sticas da Turma</h2>
            <div class="stats grid-3">
                <div class="stat-card">
                    <h3>Alunos</h3>
                    <div class="stat-value" id="totalStudents">0</div>
                </div>
                <div class="stat-card">
                    <h3>Aprovados</h3>
                    <div class="stat-value stat-aprovados" id="approvedStudents">0</div>
                </div>
                <div class="stat-card">
                    <h3>Reprovados</h3>
                    <div class="stat-value stat-reprovados" id="failedStudents">0</div>
                </div>
            </div>
        </div>
        <div class="card">
            <h2>üíæ Dados</h2>
            <p class="text-secondary-color" style="margin-top: -15px; margin-bottom: 15px;">Use as fun√ß√µes abaixo para salvar ou carregar todos os dados do sistema de uma s√≥ vez.</p>
            <div class="actions">
                <button id="exportCSV" class="btn-success">üìÑ Exportar CSV</button>
                <button id="backupData" class="btn-success">üíæ Fazer Backup</button>
                <button id="importData" class="btn-warning">üì• Importar Backup</button>
                <button id="importBulkData" class="btn-primary">üìä Importar Alunos em Massa</button>
                <button id="resetSystem" class="btn-danger">üóëÔ∏è Resetar Dados da Turma</button>
            </div>
            <input type="file" id="importFile" class="hidden" accept=".json">
        </div>
    </div>

    <!-- Modais da Aplica√ß√£o -->
    <div id="modal" class="modal-overlay" role="dialog" aria-modal="true" aria-labelledby="modalTitle"><div class="modal"><h3 id="modalTitle"></h3><p id="modalMessage"></p><div class="modal-buttons"><button id="modalConfirm" class="btn-danger">Confirmar</button><button id="modalCancel" class="btn-secondary">Cancelar</button></div></div></div>
    <div id="detailsModal" class="modal-overlay" role="dialog" aria-modal="true" aria-labelledby="detailsModalTitle"><div class="modal"><h3 id="detailsModalTitle"></h3><p id="detailsModalSubtitle"></p><div class="chart-container"><canvas id="studentChart"></canvas></div><div class="modal-buttons"><button id="detailsModalClose" class="btn-secondary">Fechar</button></div></div></div>
    <div id="boletimModal" class="modal-overlay" role="dialog" aria-modal="true"><div class="modal"><div id="boletimContent"></div><div class="modal-buttons"><button id="printBoletim" class="btn-success">üñ®Ô∏è Imprimir</button><button id="boletimModalClose" class="btn-secondary">Fechar</button></div></div></div>
    <div id="importModal" class="modal-overlay" role="dialog" aria-modal="true" aria-labelledby="importModalTitle"><div class="modal"><h3 id="importModalTitle">Importa√ß√£o de Alunos em Massa</h3><p>Cole os dados da sua planilha. A nota a ser colada √© a nota <strong>total</strong> da disciplina no bimestre. Use ponto (.) para decimais e separe colunas com ponto e v√≠rgula (;).</p><div id="importInstructions"></div><textarea id="bulkDataInput" placeholder="Ex: 123;Jo√£o da Silva;45.5;2;..."></textarea><div id="importPreview"></div><div class="modal-buttons"><button id="importModalConfirm" class="btn-success" disabled>Confirmar Importa√ß√£o</button><button id="importModalCancel" class="btn-secondary">Cancelar</button></div></div></div>
    <div id="disciplinasModal" class="modal-overlay" role="dialog" aria-modal="true" aria-labelledby="disciplinasModalTitle"><div class="modal"><h3 id="disciplinasModalTitle">Adicionar Disciplinas em Massa</h3><p>Cole a lista de disciplinas abaixo, uma por linha.</p><textarea id="bulkDisciplinasInput"></textarea><div class="modal-buttons"><button id="disciplinasModalConfirm" class="btn-success">Salvar Lista</button><button id="disciplinasModalCancel" class="btn-secondary">Cancelar</button></div></div></div>

    <script>
    /**
     * NotaSys Pro - Refactored Academic Management System
     *
     * @version 2.2.6
     * @author Gemini (Refactored & Fixed)
     * Corre√ß√£o: Adicionada verifica√ß√£o para a biblioteca de gr√°ficos (Chart.js) para
     * prevenir que uma falha no carregamento da mesma impe√ßa o resto da aplica√ß√£o
     * de funcionar, garantindo que os bot√µes permane√ßam ativos.
     */
    document.addEventListener('DOMContentLoaded', () => {
        const App = {
            // --- GERENCIAMENTO DE ESTADO ---
            state: {
                students: [],
                disciplinas: ['Portugu√™s', 'Matem√°tica'],
                studentToEdit: null,
                sort: { column: 'name', order: 'asc' },
                config: {
                    version: "2.2.6",
                    numBimestres: 1, maxAtividade: 0, maxTrabalho: 0, maxProva: 10, minNotaBimestre: 6, minNotaTotal: 60,
                    reportRanges: [20, 40, 60, 80, 100], 
                },
                charts: { studentChart: null, advancedReportChart: null },
                parsedStudents: [],
            },

            // --- UTILIT√ÅRIOS ---
            utils: {
                doc: (s) => document.querySelector(s),
                docAll: (s) => document.querySelectorAll(s),
                toId: (n) => n.toString().toLowerCase().replace(/[^a-z0-9]/g, '_'),
                showAlert(msg, type = 'success', duration = 5000) {
                    const container = this.doc('#alertContainer');
                    const alert = document.createElement('div');
                    alert.className = `alert alert-${type}`;
                    alert.textContent = msg;
                    container.innerHTML = '';
                    container.appendChild(alert);
                    setTimeout(() => alert.remove(), duration);
                },
                showModal(id, onConfirm) {
                    const modal = this.doc(id);
                    if (!modal) return;
                    modal.classList.add('visible');
                    const confirmBtn = this.doc(`${id}Confirm`);
                    const cancelBtn = this.doc(`${id}Cancel`) || this.doc(`${id}Close`);
                    const hide = () => {
                        modal.classList.remove('visible');
                        if (confirmBtn) confirmBtn.onclick = null;
                        if (cancelBtn) cancelBtn.onclick = null;
                        modal.onclick = null;
                    };
                    if (confirmBtn) {
                        confirmBtn.onclick = () => {
                            if (typeof onConfirm === 'function') {
                                onConfirm();
                            }
                            hide();
                        };
                    }
                    if (cancelBtn) cancelBtn.onclick = hide;
                    modal.onclick = (e) => { if (e.target === modal) hide(); };
                },
                debounce(func, delay) {
                    let timeout;
                    return (...args) => {
                        clearTimeout(timeout);
                        timeout = setTimeout(() => func.apply(this, args), delay);
                    };
                }
            },

            // --- ARMAZENAMENTO LOCAL ---
            storage: {
                KEYS: {
                    CONFIG: 'notasys_pro_v2_config',
                    DISCIPLINAS: 'notasys_pro_v2_disciplinas',
                    STUDENTS: 'notasys_pro_v2_students',
                    THEME: 'notasys_pro_v2_theme',
                },
                load() {
                    try {
                        const configData = localStorage.getItem(this.KEYS.CONFIG);
                        if (configData) {
                            Object.assign(App.state.config, JSON.parse(configData));
                            const disciplinasData = localStorage.getItem(this.KEYS.DISCIPLINAS);
                            if (disciplinasData) App.state.disciplinas = JSON.parse(disciplinasData);
                            const studentsData = localStorage.getItem(this.KEYS.STUDENTS);
                            if (studentsData) App.state.students = JSON.parse(studentsData);
                        } else {
                            this.migrateFromV1();
                        }
                        const theme = localStorage.getItem(this.KEYS.THEME);
                        if (theme === 'dark') {
                            App.utils.doc('body').classList.add('dark-mode');
                            App.utils.doc('#darkModeToggle').checked = true;
                        }
                    } catch (e) {
                        console.error("Error loading data:", e);
                        App.utils.showAlert('Erro fatal ao carregar dados. Verifique o console.', 'error');
                    }
                },
                save() {
                    try {
                        App.state.students.forEach(student => {
                            const updatedMetrics = App.logic.calculateTotalsAndStatus(student);
                            Object.assign(student, updatedMetrics);
                        });
                        localStorage.setItem(this.KEYS.STUDENTS, JSON.stringify(App.state.students));
                        localStorage.setItem(this.KEYS.DISCIPLINAS, JSON.stringify(App.state.disciplinas));
                        localStorage.setItem(this.KEYS.CONFIG, JSON.stringify(App.state.config));
                        return true;
                    } catch (e) {
                        console.error("Error saving data:", e);
                        App.utils.showAlert('Erro ao salvar dados.', 'error');
                        return false;
                    }
                },
                migrateFromV1() {
                    try {
                        const oldConfigData = localStorage.getItem('sistema_academico_pro_v1_config');
                        if (!oldConfigData) return;
                        App.utils.showAlert('Dados da vers√£o antiga detectados. Realizando migra√ß√£o...', 'warning', 6000);
                        const oldConfig = JSON.parse(oldConfigData);
                        const oldDisciplinas = localStorage.getItem('sistema_academico_pro_v1_disciplinas');
                        const oldStudentKey = `sistema_academico_pro_v1_students_${oldConfig.numBimestres}b`;
                        const oldStudentsData = localStorage.getItem(oldStudentKey);
                        if (oldConfig) App.state.config = { ...App.state.config, ...oldConfig };
                        if (oldDisciplinas) App.state.disciplinas = JSON.parse(oldDisciplinas);
                        if (oldStudentsData) App.state.students = JSON.parse(oldStudentsData);
                        this.save();
                    } catch (e) {
                        console.error("Migration failed:", e);
                        App.utils.showAlert('Falha na migra√ß√£o de dados. Dados antigos podem ter sido perdidos.', 'error');
                    }
                }
            },

            // --- L√ìGICA DE NEG√ìCIO ---
            logic: {
                calculateTotalsAndStatus(studentData) {
                    try {
                        let totalGeral = 0;
                        let totalFaltas = 0;
                        let abaixoMinimoDisciplina = false;
                        const bimestreTotals = [];
                        const { config, disciplinas } = App.state;
                        const maxScorePerBimestre = config.maxAtividade + config.maxTrabalho + config.maxProva;

                        for (let i = 0; i < config.numBimestres; i++) {
                            let totalBimestre = 0;
                            disciplinas.forEach(d => {
                                const nota = studentData.bimestres[i]?.[App.utils.toId(d)];
                                if (nota) {
                                    totalGeral += nota.total || 0;
                                    totalBimestre += nota.total || 0;
                                    totalFaltas += nota.faltas || 0;
                                    if (nota.total < config.minNotaBimestre) {
                                        abaixoMinimoDisciplina = true;
                                    }
                                }
                            });
                            bimestreTotals.push(totalBimestre);
                        }

                        const maxScoreTotalPossible = maxScorePerBimestre * config.numBimestres * disciplinas.length;
                        const average = maxScoreTotalPossible > 0 ? (totalGeral / maxScoreTotalPossible) * 10 : 0;
                        const isAprovado = (totalGeral >= config.minNotaTotal && !abaixoMinimoDisciplina);
                        const status = { text: isAprovado ? 'Aprovado' : 'Reprovado', class: isAprovado ? 'status-Aprovado' : 'status-Reprovado' };
                        
                        return { totalGeral: totalGeral.toFixed(1), totalFaltas, status, average, bimestreTotals }; 
                    } catch (e) {
                        console.error("Error calculating totals:", e);
                        App.utils.showAlert('Erro ao calcular totais de um aluno.', 'error');
                        return { totalGeral: '0.0', totalFaltas: 0, status: { text: 'Erro', class: 'status-Reprovado' }, average: 0, bimestreTotals: [] }; 
                    }
                },
                validateStudentData(data, isEditing) {
                    const { name, studentId } = data;
                    if (!name || !studentId) {
                        return { valid: false, message: 'Nome e matr√≠cula s√£o obrigat√≥rios.' };
                    }
                    const duplicate = App.state.students.some(s => s.studentId === studentId && s.studentId !== App.state.studentToEdit?.studentId);
                    if (duplicate) {
                        return { valid: false, message: 'Esta matr√≠cula j√° est√° em uso por outro aluno.' };
                    }
                    return { valid: true, message: '' };
                },
                validateConfig(config) {
                    if (config.numBimestres < 1 || config.numBimestres > 4) return "N√∫mero de bimestres deve ser entre 1 e 4.";
                    if (config.maxAtividade < 0 || config.maxTrabalho < 0 || config.maxProva < 0) return "Pontua√ß√µes m√°ximas n√£o podem ser negativas.";
                    if ((config.maxAtividade + config.maxTrabalho + config.maxProva) <= 0) return "A soma das pontua√ß√µes m√°ximas por bimestre deve ser maior que zero.";
                    if (config.minNotaBimestre < 0 || config.minNotaTotal < 0) return "Notas m√≠nimas n√£o podem ser negativas.";
                    return null;
                }
            },

            // --- RENDERIZA√á√ÉO E MANIPULA√á√ÉO DO DOM ---
            view: {
                init() {
                    this.populateConfigForm();
                    this.renderAll();
                    this.initEventListeners();
                },
                renderAll() {
                    this.renderDisciplinasConfig();
                    this.renderFormStructure();
                    this.renderStudents();
                    this.updateStatistics();
                    this.renderAdvancedReports();
                    this.updateConfigSummary();
                },
                initEventListeners() {
                    const debouncedUpdateFormTotals = App.utils.debounce(() => this.updateFormTotals(), 400);
                    const debouncedRenderStudents = App.utils.debounce(() => this.renderStudents(), 300);

                    App.utils.doc('#student-form').addEventListener('submit', this.handleFormSubmit.bind(this));
                    App.utils.doc('#student-form').addEventListener('input', e => {
                        if (e.target.classList.contains('nota-input')) {
                            this.validateNoteSum(e.target);
                            this.validateAndClampInput(e);
                            debouncedUpdateFormTotals();
                        }
                    });
                    
                    App.utils.doc('#studentId').addEventListener('blur', this.validateMatriculaOnBlur.bind(this));
                    App.utils.doc('#clear-form-btn').addEventListener('click', () => this.clearForm());
                    App.utils.doc('#show-add-form-btn').addEventListener('click', () => this.showAddForm());
                    App.utils.doc('#studentsList').addEventListener('click', this.handleTableClick.bind(this));
                    App.utils.doc('#studentsTable thead').addEventListener('click', this.handleSort.bind(this));
                    App.utils.doc('#searchStudent').addEventListener('input', debouncedRenderStudents);
                    App.utils.doc('#aplicarConfig').addEventListener('click', this.handleConfigApply.bind(this));
                    App.utils.doc('#adicionarDisciplina').addEventListener('click', this.handleAddDisciplina.bind(this));
                    App.utils.doc('#disciplinasList').addEventListener('click', this.handleDisciplinaRemove.bind(this));
                    App.utils.doc('#bulkAddDisciplinas').addEventListener('click', this.handleBulkAddDisciplinas.bind(this));
                    
                    App.utils.doc('#bimestreTabsContainer').addEventListener('click', e => {
                        if (e.target.matches('.bimestre-tab')) this.switchBimestreTab(e.target.dataset.bimestre);
                    });
                    
                    App.utils.doc('#darkModeToggle').addEventListener('change', e => {
                        App.utils.doc('body').classList.toggle('dark-mode', e.target.checked);
                        localStorage.setItem(App.storage.KEYS.THEME, e.target.checked ? 'dark' : 'light');
                    });

                    // A√ß√µes de dados
                    App.utils.doc('#exportCSV').addEventListener('click', this.exportCSV.bind(this));
                    App.utils.doc('#backupData').addEventListener('click', this.backupData.bind(this));
                    App.utils.doc('#importData').addEventListener('click', () => App.utils.doc('#importFile').click());
                    App.utils.doc('#importFile').addEventListener('change', this.handleImport.bind(this));
                    App.utils.doc('#importBulkData').addEventListener('click', this.showBulkImportModal.bind(this));
                    App.utils.doc('#bulkDataInput').addEventListener('input', App.utils.debounce(() => this.handleBulkDataParse(), 300));
                    App.utils.doc('#importModalConfirm').addEventListener('click', () => this.confirmBulkImport());
                    App.utils.doc('#resetSystem').addEventListener('click', this.handleResetSystem.bind(this));
                    
                    // Outros
                    App.utils.doc('#printBoletim').addEventListener('click', () => window.print());
                    App.utils.doc('#reportSubject').addEventListener('change', () => this.updateAdvancedChart());
                    App.utils.docAll('.report-range-input').forEach(input => {
                        input.addEventListener('change', App.utils.debounce(() => this.handleReportRangeChange(), 400));
                    });
                    App.utils.docAll('.config-box input').forEach(el => el.addEventListener('input', () => this.updateConfigSummary()));
                },

                populateConfigForm() {
                    const { config } = App.state;
                    for (const key in config) {
                        if (key === 'reportRanges') {
                            config.reportRanges.forEach((val, i) => {
                                const el = App.utils.doc(`#range${i + 1}`);
                                if (el) el.value = val;
                            });
                        } else {
                            const el = App.utils.doc(`#${key}`);
                            if (el) el.value = config[key];
                        }
                    }
                },
                
                updateConfigSummary() {
                    const tempConfig = this.getTempConfig();
                    App.utils.doc('#approvalRuleSummary').innerHTML = `<strong>Regra Atual:</strong> Para ser aprovado, o aluno precisa de no m√≠nimo <strong>${tempConfig.minNotaBimestre}</strong> pontos EM CADA DISCIPLINA de cada um dos <strong>${tempConfig.numBimestres}</strong> bimestres E um total de <strong>${tempConfig.minNotaTotal}</strong> pontos no ano.`;
                },

                getTempConfig() {
                    const ranges = Array.from(App.utils.docAll('.report-range-input')).map(el => parseFloat(el.value) || 0);
                    return {
                        numBimestres: parseInt(App.utils.doc('#numBimestres').value) || 1,
                        maxAtividade: parseFloat(App.utils.doc('#maxAtividade').value) || 0,
                        maxTrabalho: parseFloat(App.utils.doc('#maxTrabalho').value) || 0,
                        maxProva: parseFloat(App.utils.doc('#maxProva').value) || 0,
                        minNotaBimestre: parseFloat(App.utils.doc('#minNotaBimestre').value) || 0,
                        minNotaTotal: parseFloat(App.utils.doc('#minNotaTotal').value) || 0,
                        reportRanges: ranges
                    };
                },

                handleConfigApply() {
                    const newConfig = this.getTempConfig();
                    const validationError = App.logic.validateConfig(newConfig);
                    if (validationError) return App.utils.showAlert(validationError, 'error');

                    const oldConfig = { ...App.state.config };
                    if (JSON.stringify(oldConfig) === JSON.stringify(newConfig)) {
                        return App.utils.showAlert('Nenhuma configura√ß√£o foi alterada.', 'warning');
                    }

                    const bimestresChanged = oldConfig.numBimestres !== newConfig.numBimestres;
                    let message = 'Alterar configura√ß√µes ir√° recalcular o status de todos os alunos. Deseja continuar?';
                    
                    if (bimestresChanged && App.state.students.length > 0) {
                        if (newConfig.numBimestres < oldConfig.numBimestres) {
                            message = `Voc√™ est√° REDUZINDO o n√∫mero de bimestres. Isso remover√° permanentemente os dados dos bimestres excedentes de todos os alunos. Deseja continuar?`;
                        } else {
                            message = `Voc√™ est√° AUMENTANDO o n√∫mero de bimestres. Os novos bimestres ser√£o adicionados em branco para todos os alunos. Deseja continuar?`;
                        }
                    }
                    
                    const action = () => {
                        if (bimestresChanged) {
                            App.state.students.forEach(student => {
                                if (newConfig.numBimestres < student.bimestres.length) {
                                    student.bimestres = student.bimestres.slice(0, newConfig.numBimestres);
                                } else {
                                    while (student.bimestres.length < newConfig.numBimestres) {
                                        student.bimestres.push({});
                                    }
                                }
                            });
                        }
                        App.state.config = newConfig;
                        if (App.storage.save()) {
                            App.utils.showAlert('Configura√ß√µes aplicadas e dados recalculados!', 'success');
                            this.renderAll();
                        }
                    };

                    App.utils.showModal('#modal', action);
                    App.utils.doc('#modalTitle').textContent = 'Confirmar Mudan√ßa de Configura√ß√£o';
                    App.utils.doc('#modalMessage').textContent = message;
                },

                renderStudents() {
                    const { config } = App.state;
                    const theadRow = App.utils.doc('#studentsTable thead tr');
                    const list = App.utils.doc('#studentsList');

                    theadRow.innerHTML = '';
                    let headersHTML = `
                        <th data-sort="name">Nome</th>
                        <th data-sort="studentId">Matr√≠cula</th>
                    `;
                    for (let i = 0; i < config.numBimestres; i++) {
                        headersHTML += `<th data-sort="bimestreTotals.${i}">${i + 1}¬∫ Bim.</th>`;
                    }
                    headersHTML += `
                        <th data-sort="totalFaltas">Faltas</th>
                        <th data-sort="totalGeral">Pontos (Total)</th>
                        <th data-sort="average">M√©dia (0-10)</th>
                        <th data-sort="status.text">Status</th>
                        <th>A√ß√µes</th>
                    `;
                    theadRow.innerHTML = headersHTML;

                    list.innerHTML = '';
                    const query = App.utils.doc('#searchStudent').value.toLowerCase();
                    const filtered = App.state.students.filter(s => s.name.toLowerCase().includes(query) || String(s.studentId).toLowerCase().includes(query));
                    
                    const sorted = [...filtered].sort((a, b) => {
                        const get = (obj, path) => path.split('.').reduce((o, i) => (o ? o[i] : undefined), obj);
                        const valA = get(a, App.state.sort.column);
                        const valB = get(b, App.state.sort.column);
                        if (typeof valA === 'string') {
                            return App.state.sort.order === 'asc' ? valA.localeCompare(valB) : valB.localeCompare(valA);
                        }
                        return App.state.sort.order === 'asc' ? (valA || 0) - (valB || 0) : (valB || 0) - (valA || 0);
                    });

                    App.utils.doc('#emptyMessage').classList.toggle('hidden', sorted.length > 0);
                    sorted.forEach(s => {
                        const idx = App.state.students.findIndex(st => st.studentId === s.studentId);
                        const row = list.insertRow();
                        
                        let rowHTML = `
                            <td>${s.name}</td>
                            <td>${s.studentId}</td>
                        `;
                        for (let i = 0; i < config.numBimestres; i++) {
                            rowHTML += `<td>${(s.bimestreTotals[i] || 0).toFixed(1)}</td>`;
                        }
                        rowHTML += `
                            <td>${s.totalFaltas || 0}</td>
                            <td>${s.totalGeral}</td>
                            <td>${(s.average || 0).toFixed(1)}</td>
                            <td class="${s.status.class || ''}">${s.status.text}</td>
                            <td class="actions">
                                <button class="btn-small" data-action="boletim" data-index="${idx}" title="Gerar Boletim" aria-label="Gerar boletim de ${s.name}">üìÑ</button>
                                <button class="btn-small" data-action="details" data-index="${idx}" title="Ver Gr√°fico" aria-label="Ver detalhes e gr√°fico de ${s.name}">üìä</button>
                                <button class="btn-small" data-action="edit" data-index="${idx}" title="Editar" aria-label="Editar aluno ${s.name}">‚úèÔ∏è</button>
                                <button class="btn-small btn-danger" data-action="delete" data-index="${idx}" title="Excluir" aria-label="Excluir aluno ${s.name}">üóëÔ∏è</button>
                            </td>
                        `;
                        row.innerHTML = rowHTML;
                    });

                    App.utils.docAll('#studentsTable th').forEach(th => th.classList.remove('sort-asc', 'sort-desc'));
                    const activeSortHeader = App.utils.doc(`#studentsTable th[data-sort="${App.state.sort.column}"]`);
                    if(activeSortHeader) {
                        activeSortHeader.classList.add(App.state.sort.order === 'asc' ? 'sort-asc' : 'sort-desc');
                    }
                },

                renderFormStructure() {
                    const { numBimestres } = App.state.config;
                    const tabsContainer = App.utils.doc('#bimestreTabsContainer');
                    const contentContainer = App.utils.doc('#bimestresContentContainer');
                    tabsContainer.innerHTML = '';
                    contentContainer.innerHTML = '';
                    for (let i = 0; i < numBimestres; i++) {
                        tabsContainer.innerHTML += `<div class="bimestre-tab ${i === 0 ? 'active' : ''}" data-bimestre="${i}">${i + 1}¬∫ Bimestre</div>`;
                        contentContainer.innerHTML += `<div id="bimestre${i}" class="bimestre-content ${i > 0 ? 'hidden' : ''}"><h3>üìä Notas do ${i + 1}¬∫ Bimestre</h3><div id="disciplinasBimestre${i}"></div></div>`;
                        this.renderDisciplinasInBimestre(i);
                    }
                },

                renderDisciplinasInBimestre(bimestreIndex) {
                    const container = App.utils.doc(`#disciplinasBimestre${bimestreIndex}`);
                    if (!container) return;
                    container.innerHTML = '';
                    App.state.disciplinas.forEach(nome => {
                        const id = App.utils.toId(nome);
                        const section = document.createElement('details');
                        section.className = 'disciplina-section';
                        section.open = true;
                        section.innerHTML = `
                            <summary><h4>${nome}</h4></summary>
                            <div class="disciplina-content grid grid-5">
                                <div class="form-group"><label for="${id}${bimestreIndex}_atividade">Ativ.</label><input type="number" id="${id}${bimestreIndex}_atividade" class="nota-input" min="0" step="0.1" value="0"></div>
                                <div class="form-group"><label for="${id}${bimestreIndex}_trabalho">Trab.</label><input type="number" id="${id}${bimestreIndex}_trabalho" class="nota-input" min="0" step="0.1" value="0"></div>
                                <div class="form-group"><label for="${id}${bimestreIndex}_prova">Prova</label><input type="number" id="${id}${bimestreIndex}_prova" class="nota-input" min="0" step="0.1" value="0"></div>
                                <div class="form-group"><label for="${id}${bimestreIndex}_faltas">Faltas</label><input type="number" id="${id}${bimestreIndex}_faltas" class="nota-input" min="0" step="1" value="0"></div>
                                <div class="form-group"><label for="${id}${bimestreIndex}_total">Total</label><input type="text" id="${id}${bimestreIndex}_total" class="total-display" readonly value="0.0"></div>
                            </div>`;
                        container.appendChild(section);
                    });
                },
                
                updateFormTotals() {
                    const studentData = this.getFormData();
                    const { totalGeral, status } = App.logic.calculateTotalsAndStatus(studentData);
                    App.utils.doc(`#totalGeral`).value = totalGeral;
                    App.utils.doc(`#statusFinal`).value = status.text;
                    App.utils.doc(`#statusFinal`).className = `total-display ${status.class || ''}`;
                },
                
                validateNoteSum(targetInput) {
                    const idParts = targetInput.id.match(/^([a-z0-9_]+)(\d+)_(\w+)$/);
                    if(!idParts) return;
                    const baseId = idParts[1];
                    const bimestreIndex = idParts[2];
                    const { config } = App.state;
                    const maxTotal = config.maxAtividade + config.maxTrabalho + config.maxProva;
                    
                    const atv = parseFloat(App.utils.doc(`#${baseId}${bimestreIndex}_atividade`).value) || 0;
                    const trb = parseFloat(App.utils.doc(`#${baseId}${bimestreIndex}_trabalho`).value) || 0;
                    const prv = parseFloat(App.utils.doc(`#${baseId}${bimestreIndex}_prova`).value) || 0;
                    
                    const currentSum = atv + trb + prv;
                    if (currentSum > maxTotal && maxTotal > 0) {
                        const overage = currentSum - maxTotal;
                        let currentValue = parseFloat(targetInput.value);
                        targetInput.value = (currentValue - overage).toFixed(1);
                        App.utils.showAlert(`Soma das notas excede o m√°ximo (${maxTotal}). Valor ajustado.`, 'warning');
                        this.updateFormTotals();
                    }
                },
                
                validateAndClampInput(e) {
                    const input = e.target;
                    if (!input.value) return;
                    let value = parseFloat(input.value);
                    const min = parseFloat(input.min) ?? 0;
                    if (input.id.includes('faltas')) {
                        if (value < min || !Number.isInteger(value)) input.value = Math.max(min, Math.floor(value) || 0);
                        return;
                    }
                    const { config } = App.state;
                    let max;
                    if (input.id.includes('atividade')) max = config.maxAtividade;
                    else if (input.id.includes('trabalho')) max = config.maxTrabalho;
                    else if (input.id.includes('prova')) max = config.maxProva;
                    if (max !== undefined && value > max) input.value = max;
                    if (value < min) input.value = min;
                },
                
                getFormData() {
                    const studentData = { bimestres: [], disciplinas: App.state.disciplinas };
                    const { numBimestres, maxAtividade, maxTrabalho, maxProva } = App.state.config;
                    const maxTotal = maxAtividade + maxTrabalho + maxProva;
                    for (let i = 0; i < numBimestres; i++) {
                        studentData.bimestres[i] = {};
                        App.state.disciplinas.forEach(d => {
                            const id = App.utils.toId(d);
                            const doc = App.utils.doc;
                            const atv = parseFloat(doc(`#${id}${i}_atividade`)?.value) || 0;
                            const trb = parseFloat(doc(`#${id}${i}_trabalho`)?.value) || 0;
                            const prv = parseFloat(doc(`#${id}${i}_prova`)?.value) || 0;
                            const faltas = parseInt(doc(`#${id}${i}_faltas`)?.value) || 0;
                            const total = Math.min(atv + trb + prv, maxTotal);
                            if (doc(`#${id}${i}_total`)) doc(`#${id}${i}_total`).value = total.toFixed(1);
                            studentData.bimestres[i][id] = { total, faltas, atividade: atv, trabalho: trb, prova: prv };
                        });
                    }
                    studentData.name = App.utils.doc('#studentName').value.trim();
                    studentData.studentId = App.utils.doc('#studentId').value.trim();
                    return studentData;
                },
                
                handleFormSubmit(e) {
                    e.preventDefault();
                    const btn = e.target.querySelector('button[type="submit"]');
                    btn.disabled = true;
                    const studentData = this.getFormData();
                    const isEditing = !!App.state.studentToEdit;
                    const validation = App.logic.validateStudentData(studentData, isEditing);
                    if (!validation.valid) {
                        App.utils.showAlert(validation.message, 'error');
                        btn.disabled = false;
                        return;
                    }
                    const metrics = App.logic.calculateTotalsAndStatus(studentData);
                    const finalStudent = { ...studentData, ...metrics };
                    if (isEditing) {
                        const studentIndex = App.state.students.findIndex(s => s.studentId === App.state.studentToEdit.studentId);
                        if (studentIndex > -1) App.state.students[studentIndex] = finalStudent;
                    } else {
                        App.state.students.push(finalStudent);
                    }
                    if (App.storage.save()) {
                        App.utils.showAlert(`Aluno "${finalStudent.name}" ${isEditing ? 'atualizado' : 'cadastrado'}!`);
                        this.renderStudents();
                        this.updateStatistics();
                        this.renderAdvancedReports();
                        this.clearForm();
                    }
                    btn.disabled = false;
                },
                
                clearForm() {
                    const form = App.utils.doc('#student-form');
                    form.reset();
                    form.classList.add('hidden');
                    App.utils.doc('#form-placeholder').classList.remove('hidden');
                    App.utils.doc('#studentId').classList.remove('is-invalid');
                    App.utils.doc('#studentId-validation').textContent = '';
                    App.state.studentToEdit = null;
                    this.updateFormTotals();
                },
                
                showAddForm() {
                    this.clearForm();
                    App.utils.doc('#student-form-title').textContent = 'üë®‚Äçüéì Adicionar Novo Aluno';
                    App.utils.doc('#form-placeholder').classList.add('hidden');
                    App.utils.doc('#student-form').classList.remove('hidden');
                    App.utils.doc('#submit-btn').textContent = 'üíæ Salvar Novo Aluno';
                    App.utils.doc('#student-management-card').scrollIntoView({ behavior: 'smooth' });
                },
                
                populateForm(student) {
                    this.clearForm();
                    App.state.studentToEdit = student;
                    const doc = App.utils.doc;
                    doc('#student-form-title').textContent = `‚úèÔ∏è Editando: ${student.name}`;
                    doc('#studentName').value = student.name;
                    doc('#studentId').value = student.studentId;
                    for (let i = 0; i < App.state.config.numBimestres; i++) {
                        App.state.disciplinas.forEach(d => {
                            const id = App.utils.toId(d);
                            const nota = student.bimestres[i]?.[id] || {};
                            doc(`#${id}${i}_atividade`).value = nota.atividade || 0;
                            doc(`#${id}${i}_trabalho`).value = nota.trabalho || 0;
                            doc(`#${id}${i}_prova`).value = nota.prova || 0;
                            doc(`#${id}${i}_faltas`).value = nota.faltas || 0;
                        });
                    }
                    this.updateFormTotals();
                    doc('#form-placeholder').classList.add('hidden');
                    doc('#student-form').classList.remove('hidden');
                    doc('#submit-btn').textContent = 'üíæ Atualizar Aluno';
                    doc('#student-management-card').scrollIntoView({ behavior: 'smooth' });
                },
                
                handleTableClick(e) {
                    const target = e.target.closest('button');
                    if (!target) return;
                    const action = target.dataset.action;
                    const index = parseInt(target.dataset.index);
                    const student = App.state.students[index];
                    if (!student) return;

                    switch (action) {
                        case 'edit': this.populateForm(student); break;
                        case 'delete':
                            App.utils.showModal('#modal', () => {
                                App.state.students.splice(index, 1);
                                if (App.storage.save()) {
                                    this.renderAll();
                                    App.utils.showAlert(`"${student.name}" exclu√≠do!`);
                                }
                            });
                            App.utils.doc('#modalTitle').textContent = 'Excluir Aluno';
                            App.utils.doc('#modalMessage').textContent = `Tem certeza que deseja excluir "${student.name}"? Esta a√ß√£o n√£o pode ser desfeita.`;
                            break;
                        case 'details': this.showStudentDetails(student); break;
                        case 'boletim': this.showBoletim(student); break;
                    }
                },
                
                validateMatriculaOnBlur() {
                    const input = App.utils.doc('#studentId');
                    const validationMsg = App.utils.doc('#studentId-validation');
                    const studentId = input.value.trim();
                    if (!studentId) {
                        input.classList.remove('is-invalid');
                        validationMsg.textContent = '';
                        return;
                    }
                    const isDuplicate = App.state.students.some(s => s.studentId === studentId && s.studentId !== App.state.studentToEdit?.studentId);
                    if (isDuplicate) {
                        input.classList.add('is-invalid');
                        validationMsg.textContent = 'Esta matr√≠cula j√° est√° em uso.';
                    } else {
                        input.classList.remove('is-invalid');
                        validationMsg.textContent = '';
                    }
                },
                
                handleSort(e) {
                    const column = e.target.dataset.sort;
                    if (!column) return;
                    const { sort } = App.state;
                    if (sort.column === column) {
                        sort.order = sort.order === 'asc' ? 'desc' : 'asc';
                    } else {
                        sort.column = column;
                        sort.order = 'asc';
                    }
                    this.renderStudents();
                },
                
                switchBimestreTab(bimestreIndex) {
                    App.utils.docAll(`#bimestreTabsContainer .bimestre-tab`).forEach(t => t.classList.remove('active'));
                    App.utils.docAll(`#bimestresContentContainer .bimestre-content`).forEach(c => c.classList.add('hidden'));
                    App.utils.doc(`.bimestre-tab[data-bimestre="${bimestreIndex}"]`).classList.add('active');
                    App.utils.doc(`#bimestre${bimestreIndex}`).classList.remove('hidden');
                },
                
                updateStatistics() {
                    const total = App.state.students.length;
                    const approved = App.state.students.filter(s => s.status.text === 'Aprovado').length;
                    App.utils.doc('#totalStudents').textContent = total;
                    App.utils.doc('#approvedStudents').textContent = approved;
                    App.utils.doc('#failedStudents').textContent = total - approved;
                },
                
                showStudentDetails(student) {
                    // CORRE√á√ÉO: Adiciona uma verifica√ß√£o para a exist√™ncia do Chart.js
                    if (typeof Chart === 'undefined') {
                        console.error('Chart.js not loaded');
                        App.utils.showAlert('N√£o foi poss√≠vel carregar o gr√°fico. Verifique a conex√£o com a internet.', 'error');
                        return;
                    }

                    App.utils.doc('#detailsModalTitle').textContent = `Desempenho de: ${student.name}`;
                    App.utils.doc('#detailsModalSubtitle').textContent = `M√©dia Geral: ${(student.average || 0).toFixed(1)} | Status: ${student.status.text}`;
                    const { config } = App.state;
                    const labels = App.state.disciplinas;
                    const data = labels.map(d => {
                        let total = 0;
                        const id = App.utils.toId(d);
                        for (let i = 0; i < config.numBimestres; i++) total += student.bimestres[i]?.[id]?.total || 0;
                        return total;
                    });
                    const maxScorePerSubject = (config.maxAtividade + config.maxTrabalho + config.maxProva) * config.numBimestres;
                    if (App.state.charts.studentChart) App.state.charts.studentChart.destroy();
                    const ctx = App.utils.doc('#studentChart').getContext('2d');
                    App.state.charts.studentChart = new Chart(ctx, {
                        type: 'bar',
                        data: { labels, datasets: [{ label: 'Pontua√ß√£o Total', data, backgroundColor: '#F2C94C' }] },
                        options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, max: maxScorePerSubject > 0 ? maxScorePerSubject : 100 } }, plugins: { legend: { display: false } } }
                    });
                    App.utils.showModal('#detailsModal');
                },
                
                showBoletim(student) {
                    const { config, disciplinas } = App.state;
                    let content = `<h3>Boletim - ${student.name}</h3><p><strong>Matr√≠cula:</strong> ${student.studentId}</p><table><thead><tr><th>Disciplina</th>`;
                    for (let i = 0; i < config.numBimestres; i++) content += `<th>${i + 1}¬∫ Bimestre</th>`;
                    content += `<th>Total</th></tr></thead><tbody>`;
                    disciplinas.forEach(d => {
                        let totalDisc = 0;
                        const id = App.utils.toId(d);
                        content += `<tr><td>${d}</td>`;
                        for (let i = 0; i < config.numBimestres; i++) {
                            const nota = student.bimestres[i]?.[id]?.total || 0;
                            totalDisc += nota;
                            content += `<td>${nota.toFixed(1)}</td>`;
                        }
                        content += `<td><strong>${totalDisc.toFixed(1)}</strong></td></tr>`;
                    });
                    content += `</tbody></table><br><strong>Total de Pontos Anual: ${student.totalGeral}</strong><br><strong>Status Final: ${student.status.text}</strong>`;
                    App.utils.doc('#boletimContent').innerHTML = content;
                    App.utils.showModal('#boletimModal');
                },
                
                renderAdvancedReports() {
                    const select = App.utils.doc('#reportSubject');
                    select.innerHTML = App.state.disciplinas.map(d => `<option value="${d}">${d}</option>`).join('');
                    if (App.state.disciplinas.length > 0) this.updateAdvancedChart();
                },
                
                handleReportRangeChange() {
                    const ranges = Array.from(App.utils.docAll('.report-range-input')).map(el => parseFloat(el.value));
                    for (let i = 0; i < ranges.length - 1; i++) {
                        if (ranges[i] >= ranges[i + 1]) {
                            ranges[i + 1] = ranges[i] + 1;
                            App.utils.doc(`#range${i + 2}`).value = ranges[i + 1];
                        }
                    }
                    App.state.config.reportRanges = ranges;
                    App.storage.save();
                    this.updateAdvancedChart();
                },
                
                updateAdvancedChart() {
                    // CORRE√á√ÉO: Adiciona uma verifica√ß√£o para a exist√™ncia do Chart.js
                    if (typeof Chart === 'undefined') {
                        console.error('Chart.js not loaded. Cannot update advanced chart.');
                        return;
                    }

                    const subjectName = App.utils.doc('#reportSubject').value;
                    if (!subjectName) return;
                    const subjectId = App.utils.toId(subjectName);
                    const { config, students } = App.state;
                    const rangesConfig = config.reportRanges;
                    const labels = [`0-${rangesConfig[0]}%`, ...rangesConfig.slice(0, -1).map((r, i) => `${r + 1}-${rangesConfig[i + 1]}%`)];
                    const ranges = labels.reduce((acc, label) => ({ ...acc, [label]: 0 }), {});
                    const maxScoreBimestre = config.maxAtividade + config.maxTrabalho + config.maxProva;
                    const maxScoreTotal = maxScoreBimestre * config.numBimestres;
                    if (maxScoreTotal > 0) {
                        students.forEach(s => {
                            let totalNota = 0;
                            for (let i = 0; i < config.numBimestres; i++) totalNota += s.bimestres[i]?.[subjectId]?.total || 0;
                            const percent = (totalNota / maxScoreTotal) * 100;
                            for (let i = 0; i < rangesConfig.length; i++) {
                                const prevRange = i > 0 ? rangesConfig[i-1] : 0;
                                if (percent > prevRange && percent <= rangesConfig[i]) {
                                    ranges[labels[i]]++;
                                    break;
                                }
                            }
                        });
                    }
                    if (App.state.charts.advancedReportChart) App.state.charts.advancedReportChart.destroy();
                    App.state.charts.advancedReportChart = new Chart(App.utils.doc('#advancedReportChart').getContext('2d'), {
                        type: 'bar',
                        data: { labels: Object.keys(ranges), datasets: [{ label: `Alunos por faixa de nota em ${subjectName}`, data: Object.values(ranges), backgroundColor: ['#D73A49', '#F2994A', '#F2C94C', '#28A745', '#218838'] }] },
                        options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } }, plugins: { legend: { display: false } } }
                    });
                },
                
                renderDisciplinasConfig() {
                    const list = App.utils.doc('#disciplinasList');
                    list.innerHTML = '';
                    App.state.disciplinas.forEach(d => {
                        list.innerHTML += `<span class="disciplina-tag">${d}<button data-disciplina="${d}" title="Remover" aria-label="Remover ${d}">√ó</button></span>`;
                    });
                },
                
                handleAddDisciplina() {
                    const input = App.utils.doc('#novaDisciplina');
                    const nome = input.value.trim();
                    if (!nome) return;
                    if (App.state.disciplinas.map(d => d.toLowerCase()).includes(nome.toLowerCase())) {
                        return App.utils.showAlert('Essa disciplina j√° existe.', 'warning');
                    }
                    const action = () => {
                        App.state.disciplinas.push(nome);
                        if (App.storage.save()) {
                            App.utils.showAlert('Disciplina adicionada!', 'success');
                            this.renderAll();
                            input.value = '';
                        }
                    };
                    if (App.state.students.length > 0) {
                        App.utils.showModal('#modal', action);
                        App.utils.doc('#modalTitle').textContent = 'Adicionar Disciplina';
                        App.utils.doc('#modalMessage').textContent = 'Adicionar uma nova disciplina ir√° afetar todos os alunos cadastrados. Deseja continuar?';
                    } else { action(); }
                },
                
                handleDisciplinaRemove(e) {
                    if (!e.target.dataset.disciplina) return;
                    const nome = e.target.dataset.disciplina;
                    const action = () => {
                        App.state.disciplinas = App.state.disciplinas.filter(d => d !== nome);
                        if (App.storage.save()) {
                            App.utils.showAlert('Disciplina removida!', 'success');
                            this.renderAll();
                        }
                    };
                    if (App.state.students.length > 0) {
                        App.utils.showModal('#modal', action);
                        App.utils.doc('#modalTitle').textContent = 'Remover Disciplina';
                        App.utils.doc('#modalMessage').textContent = `Remover "${nome}" ir√° apagar todas as notas associadas a ela em todos os alunos. Deseja continuar?`;
                    } else { action(); }
                },
                
                handleBulkAddDisciplinas() {
                    const modal = App.utils.doc('#disciplinasModal');
                    modal.querySelector('textarea').value = App.state.disciplinas.join('\n');
                    const confirmAction = () => {
                        const text = modal.querySelector('textarea').value;
                        const novasDisciplinas = text.split('\n').map(d => d.trim()).filter(Boolean);
                        const finalAction = () => {
                            App.state.disciplinas = novasDisciplinas;
                            if (App.storage.save()) {
                                App.utils.showAlert('Lista de disciplinas atualizada!', 'success');
                                this.renderAll();
                            }
                        };
                        if (App.state.students.length > 0) {
                            App.utils.showModal('#modal', finalAction);
                            App.utils.doc('#modalTitle').textContent = 'Atualizar Disciplinas';
                            App.utils.doc('#modalMessage').textContent = 'Alterar a lista de disciplinas ir√° afetar todos os alunos e pode remover dados. Deseja continuar?';
                        } else {
                            finalAction();
                        }
                    };
                    App.utils.showModal('#disciplinasModal', confirmAction);
                },
                
                exportCSV() {
                    const { config, disciplinas, students } = App.state;
                    let csvContent = "data:text/csv;charset=utf-8,";
                    let headers = ['Matricula', 'Nome'];
                    for (let i = 0; i < config.numBimestres; i++) {
                        disciplinas.forEach(d => {
                            headers.push(`${d}_Nota_Bim${i + 1}`);
                            headers.push(`${d}_Faltas_Bim${i + 1}`);
                        });
                    }
                    headers.push('Total_Pontos', 'Status');
                    csvContent += headers.join(';') + '\r\n';
                    students.forEach(s => {
                        let row = [`"${s.studentId}"`, `"${s.name}"`];
                        for (let i = 0; i < config.numBimestres; i++) {
                            disciplinas.forEach(d => {
                                const nota = s.bimestres[i]?.[App.utils.toId(d)];
                                row.push(nota?.total || 0);
                                row.push(nota?.faltas || 0);
                            });
                        }
                        row.push(s.totalGeral, s.status.text);
                        csvContent += row.join(';') + '\r\n';
                    });
                    const encodedUri = encodeURI(csvContent);
                    const link = document.createElement("a");
                    link.setAttribute("href", encodedUri);
                    link.setAttribute("download", "export_alunos.csv");
                    document.body.appendChild(link);
                    link.click();
                    link.remove();
                },
                
                backupData() {
                    const backup = { version: "2.2.6", students: App.state.students, config: App.state.config, disciplinas: App.state.disciplinas };
                    const blob = new Blob([JSON.stringify(backup, null, 2)], { type: 'application/json' });
                    const link = document.createElement('a');
                    link.href = URL.createObjectURL(blob);
                    link.download = `backup_notasys_pro_${new Date().toISOString().slice(0, 10)}.json`;
                    link.click();
                    URL.revokeObjectURL(link.href);
                },
                
                handleImport(e) {
                    const file = e.target.files[0];
                    if (!file) return;
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        try {
                            const data = JSON.parse(event.target.result);
                            if (data.students && data.disciplinas) {
                                App.utils.showModal('#modal', () => {
                                    App.state.disciplinas = data.disciplinas;
                                    App.state.students = data.students;
                                    if (App.storage.save()) {
                                        App.utils.showAlert(`Backup importado! Alunos e disciplinas foram restaurados.`);
                                        this.init();
                                    }
                                });
                                App.utils.doc('#modalTitle').textContent = 'Importar Dados de Alunos e Disciplinas';
                                App.utils.doc('#modalMessage').textContent = 'Isto substituir√° a lista de alunos e disciplinas atuais pelos dados do arquivo. As configura√ß√µes da turma N√ÉO ser√£o alteradas. Continuar?';
                            } else { App.utils.showAlert('Arquivo de backup inv√°lido. Deve conter as chaves "students" e "disciplinas".', 'error'); }
                        } catch (err) {
                            App.utils.showAlert('Erro ao ler o arquivo. Verifique se √© um JSON v√°lido.', 'error');
                            console.error("Import Parse Error:", err);
                        }
                    };
                    reader.readAsText(file);
                    e.target.value = '';
                },
                
                showBulkImportModal() {
                    const { config, disciplinas } = App.state;
                    let headers = ['Matr√≠cula', 'Nome'];
                    for (let i = 0; i < config.numBimestres; i++) {
                        disciplinas.forEach(d => headers.push(`${d} (Nota ${i + 1}B)`, `${d} (Faltas ${i + 1}B)`));
                    }
                    App.utils.doc('#importInstructions').innerHTML = `<p><strong>Aten√ß√£o:</strong> A nota importada ser√° atribu√≠da √† categoria 'Prova' de cada disciplina, e as demais ('Atividade', 'Trabalho') ser√£o zeradas.</p><p><strong>Formato esperado (${headers.length} colunas):</strong><br>${headers.join('; ')}</p>`;
                    App.utils.doc('#importPreview').innerHTML = '';
                    App.utils.doc('#bulkDataInput').value = '';
                    App.utils.doc('#importModalConfirm').disabled = true;
                    App.utils.showModal('#importModal');
                },
                
                handleBulkDataParse() {
                    const text = App.utils.doc('#bulkDataInput').value.trim();
                    const lines = text.split('\n').filter(line => line.trim() !== '');
                    const { config, disciplinas } = App.state;
                    const expectedCols = 2 + (disciplinas.length * 2 * config.numBimestres);
                    App.state.parsedStudents = [];
                    let previewHtml = '<table><tr><th>Matr√≠cula</th><th>Nome</th><th>Status</th></tr>';
                    let hasErrors = false;
                    lines.forEach(line => {
                        const cols = line.split(';');
                        if (cols.length !== expectedCols) {
                            previewHtml += `<tr class="error-row"><td>${cols[0] || ''}</td><td>${cols[1] || ''}</td><td>Erro: N√∫mero de colunas incorreto (${cols.length} de ${expectedCols}).</td></tr>`;
                            hasErrors = true;
                            return;
                        }
                        const [studentId, name, ...notasFaltas] = cols;
                        const student = { studentId, name, bimestres: Array.from({ length: config.numBimestres }, () => ({})) };
                        for (let i = 0; i < config.numBimestres; i++) {
                            for (let j = 0; j < disciplinas.length; j++) {
                                const nota = parseFloat(notasFaltas[(i * disciplinas.length * 2) + (j * 2)]?.replace(',', '.')) || 0;
                                const faltas = parseInt(notasFaltas[(i * disciplinas.length * 2) + (j * 2) + 1]) || 0;
                                student.bimestres[i][App.utils.toId(disciplinas[j])] = { atividade: 0, trabalho: 0, prova: nota, total: nota, faltas };
                            }
                        }
                        App.state.parsedStudents.push(student);
                        previewHtml += `<tr><td>${studentId}</td><td>${name}</td><td>Pronto para importar</td></tr>`;
                    });
                    previewHtml += '</table>';
                    App.utils.doc('#importPreview').innerHTML = previewHtml;
                    App.utils.doc('#importModalConfirm').disabled = hasErrors || App.state.parsedStudents.length === 0;
                },
                
                confirmBulkImport() {
                    if (App.state.parsedStudents.length === 0) return;
                    
                    App.utils.doc('#importModal').classList.remove('visible');

                    App.utils.showModal('#modal', () => {
                        App.state.students.push(...App.state.parsedStudents);
                        if (App.storage.save()) {
                            App.utils.showAlert(`${App.state.parsedStudents.length} aluno(s) importado(s) com sucesso!`);
                            this.renderAll();
                        }
                    });
                    
                    App.utils.doc('#modalTitle').textContent = 'Confirmar Importa√ß√£o em Massa';
                    App.utils.doc('#modalMessage').textContent = `Voc√™ tem certeza que deseja adicionar ${App.state.parsedStudents.length} novo(s) aluno(s) √† lista atual? Essa a√ß√£o n√£o pode ser desfeita.`;
                },
                
                handleResetSystem() {
                    App.utils.showModal('#modal', () => {
                        localStorage.removeItem(App.storage.KEYS.STUDENTS);
                        localStorage.removeItem(App.storage.KEYS.DISCIPLINAS);
                        location.reload();
                    });
                    App.utils.doc('#modalTitle').textContent = 'Resetar Dados da Turma';
                    App.utils.doc('#modalMessage').textContent = 'ATEN√á√ÉO: Esta a√ß√£o √© irrevers√≠vel e ir√° apagar a lista de DISCIPLINAS e TODOS os ALUNOS cadastrados. As configura√ß√µes da turma ser√£o mantidas. Deseja continuar?';
                }
            },

            // --- INICIALIZA√á√ÉO DA APLICA√á√ÉO ---
            init() {
                this.storage.load();
                this.view.init();
            }
        };

        App.init();
    });
    </script>
</body>
</html>

